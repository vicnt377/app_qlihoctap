<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<div class="dashboard-header">
  <h2 class="dashboard-title mb-0"><i class="fas fa-graduation-cap"></i> K·∫øt Qu·∫£ H·ªçc T·∫≠p</h2>

  <div class="user-info position-relative">
    <img src="{{user.avatar}}" alt="Avatar" class="user-avatar dropdown-toggle"
         onerror="this.onerror=null;this.src='/img/avatar.png';"
         id="avatarDropdown" />

    <span class="user-name">{{user.username}}</span>

    <!-- Menu dropdown -->
    <div class="dropdown-menu-user" id="userMenu">
      <a href="/account" class="dropdown-item"><i class="fas fa-pen"></i> Ch·ªânh s·ª≠a th√¥ng tin</a>
      <a href="/login/logout" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
    </div>
  </div>
</div>


<main class="row g-3 mb-4">
    <form method="GET" action="/score" class="row g-3 mb-4">
        <div class="col-md-4">
            <select name="year" class="form-select">
                <option value="T·∫•t c·∫£" {{#if (eq selectedYear 'T·∫•t c·∫£')}}selected{{/if}}>T·∫•t c·∫£</option>
                    {{#each years}}
                        <option value="{{this}}" {{#if (eq ../selectedYear this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
        </div>
        <div class="col-md-4">
            <select name="semester" class="form-select">
                <option value="T·∫•t c·∫£" {{#if (eq selectedSemester 'T·∫•t c·∫£')}}selected{{/if}}>T·∫•t c·∫£</option>
                    {{#each semestersList}}
                        <option value="{{this}}" {{#if (eq ../selectedSemester this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary"> üîç </button>
        </div>

    </form>

    <!-- C·ªôt T·ªïng K·∫øt To√†n Kh√≥a (Chi·∫øm 30% chi·ªÅu r·ªông) -->
    <div class="col-md-4">
        <div class="card p-4">
            <h5>üìå T·ªïng K·∫øt To√†n Kho√°</h5>
            <p><strong>Trung B√¨nh T√≠ch L≈©y:</strong><span class="badge bg-info"> {{cumulative}}</span></p>
            <p><strong>X·∫øp lo·∫°i h·ªçc l·ª±c:</strong><span class="badge bg-warning text-dark"> {{hocLuc}}</span></p>
        </div>
    </div>

    <!-- C·ªôt B·∫£ng ƒêi·ªÉm (Chi·∫øm 70% chi·ªÅu r·ªông) -->
    <div class="col-md-8">
        <div class="card p-4">
            {{#each semesters}}
            <h4 style="color: #17a2b8">{{tenHocKy}} - {{namHoc}}</h4>
            <form method="POST" action="/score/update">
                <table class="table table-bordered" data-semester>
                    <thead>
                        <tr>
                            <th>M√£ H·ªçc Ph·∫ßn</th>
                            <th>T√™n H·ªçc Ph·∫ßn</th>
                            <th>S·ªë T√≠n Ch·ªâ</th>
                            <th>ƒêi·ªÉm S·ªë</th>
                            <th>ƒêi·ªÉm Ch·ªØ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each score}}
                        <tr>
                            <td>{{HocPhan.maHocPhan}}</td>
                            <td>{{HocPhan.tenHocPhan}}</td>
                            <td>{{HocPhan.soTinChi}}</td>
                            <td>
                                <input type="number" step="0.1" min="0" max="10" name="scores[{{_id}}][diemSo]" class="form-control" value="{{default diemSo 0}}">
                            </td>
                            <td>
                                <input type="text" name="scores[{{_id}}][diemChu]" class="form-control" value="{{diemChu}}">
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
                <button type="submit" class="btn btn-success mt-2">üíæ L∆∞u ƒëi·ªÉm</button>
            </form>
            {{/each}}
        </div>
    </div>
</main>

<script>
    function convertDiemSoToDiemChu(diemSo) {
        const score = parseFloat(diemSo);
        if (isNaN(score)) return '';

        if (score >= 9.0) return 'A';
        if (score >= 8.0) return 'B+';
        if (score >= 7.0) return 'B';
        if (score >= 6.0) return 'C+';
        if (score >= 5.0) return 'C';
        if (score >= 4.0) return 'D';
        return 'F';
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('input[name^="scores"][name$="[diemSo]"]').forEach(input => {
            input.addEventListener('input', (e) => {
                const scoreInput = e.target;
                const diemChuInput = scoreInput.closest('tr').querySelector('input[name$="[diemChu]"]');

                const diemSo = scoreInput.value;
                diemChuInput.value = convertDiemSoToDiemChu(diemSo);
            });
        });
    });
</script>


<style>
    .hover-shadow:hover {
        transform: translateY(-5px);
        transition: 0.3s ease;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(0, 0, 0, 0.85);
    padding: 15px 20px;
    border-radius: 12px;
    color: white;
    margin-bottom: 24px;
  }

  .user-name {
    font-weight: 500;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    cursor: pointer;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid white;
  }

  .dropdown-menu-user {
    position: absolute;
    top: 50px;
    right: 0;
    background-color: white;
    color: #333;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    display: none;
    min-width: 180px;
    z-index: 999;
  }

  .dropdown-menu-user a {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: #333;
  }

  .dropdown-menu-user a:hover {
    background-color: #f2f2f2;
  }
</style>


<script>
  const avatar = document.getElementById('avatarDropdown');
  const menu = document.getElementById('userMenu');
  const userInfo = avatar.parentElement;

  function isChildOf(parent, child) {
    while (child) {
      if (child === parent) return true;
      child = child.parentElement;
    }
    return false;
  }

  userInfo.addEventListener('mouseover', () => {
    menu.style.display = 'block';
  });

  userInfo.addEventListener('mouseout', (e) => {
    if (!isChildOf(userInfo, e.relatedTarget)) {
      menu.style.display = 'none';
    }
  });

  // ƒê·∫£m b·∫£o menu kh√¥ng bi·∫øn m·∫•t khi chu·ªôt ƒëang ·ªü trong menu
  menu.addEventListener('mouseover', () => {
    menu.style.display = 'block';
  });

  menu.addEventListener('mouseout', (e) => {
    if (!isChildOf(userInfo, e.relatedTarget)) {
      menu.style.display = 'none';
    }
  });
</script>


