{{!< admin}}
<title>Admin - Chat Box</title>

<div class="dashboard-header mb-4">
  <h3 class="dashboard-title text-2xl">H·ªôp th∆∞ & Tr√≤ chuy·ªán</h3>
</div>

<main class="container-fluid">
  <div class="row">
    <!-- üü¶ C·ªòT TR√ÅI: Danh s√°ch ng∆∞·ªùi d√πng -->
    <div class="col-md-4 border-end" style="max-height: 80vh; overflow-y: auto;">
      <h5 class="mb-3"><strong>Danh s√°ch ng∆∞·ªùi d√πng</strong></strong></h5>
      {{#if chats.length}}
        <ul class="list-group" id="userList">
          {{#each chats}}
            <li 
            class="list-group-item d-flex justify-content-between align-items-center user-item"
            data-user-id="{{this.user._id}}" 
            data-username="{{this.user.username}}">
            <div>
                <strong>{{this.user.username}}</strong><br>
                <small>{{this.lastMessage}}</small>
            </div>

            <!-- üî• Badge th√¥ng b√°o -->
            <span
                class="badge bg-danger {{#unless this.unreadCount}}d-none{{/unless}}"
                id="badge-{{this.user._id}}">
                {{this.unreadCount}}
            </span>

            </li>

          {{/each}}
        </ul>
      {{else}}
        <p>Kh√¥ng c√≥ tin nh·∫Øn n√†o.</p>
      {{/if}}
    </div>

    <!-- üü© C·ªòT PH·∫¢I: Khung chat -->
    <div class="col-md-8">
      <div id="chatSection" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><strong>Tr√≤ chuy·ªán v·ªõi <span id="chatUsername"></span></strong></h5>
        </div>

        <div class="border rounded p-3 mb-3" id="chatBox" style="max-height: 60vh; overflow-y: auto;">
          <!-- Tin nh·∫Øn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </div>

        <div class="d-flex mt-3">
          <input type="text" id="adminMessageInput" class="form-control me-2" placeholder="Nh·∫≠p tin nh·∫Øn...">
          <button id="sendBtn" class="btn btn-primary">G·ª≠i</button>
        </div>
      </div>

      <div id="noChatSelected" class="text-muted text-center mt-5">
        <i class="far fa-comments fa-2x mb-2"></i>
        <p>Ch·ªçn m·ªôt ng∆∞·ªùi d√πng t·ª´ danh s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán </p>
      </div>
    </div>
  </div>
</main>


<script src="/socket.io/socket.io.js"></script>
<script>

  // ‚≠ê Socket ri√™ng cho Admin Chat
  const adminSocket = io();

  const adminId = '{{adminId}}';
  let currentUserId = null;

  // ‚≠ê ƒêƒÉng k√Ω admin
  adminSocket.emit('register', { userId: adminId });

  // ‚≠ê Khi ch·ªçn 1 user t·ª´ danh s√°ch
  document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', async () => {

      currentUserId = item.dataset.userId;
      const username = item.dataset.username;

      // ‚≠ê ·∫®n badge khi admin m·ªü ƒëo·∫°n chat
      const badge = document.getElementById(`badge-${currentUserId}`);
      if (badge) {
        badge.classList.add('d-none');
        badge.innerText = "";
      }

      // üî• G·ª≠i API ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc
      fetch(`/admin/chat/mark-read/${currentUserId}`, { method: 'POST' });


      document.getElementById('chatUsername').innerText = username;
      document.getElementById('noChatSelected').classList.add('d-none');
      document.getElementById('chatSection').classList.remove('d-none');

      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '<p class="text-muted">ƒêang t·∫£i tin nh·∫Øn...</p>';

      // üî• L·∫•y l·ªãch s·ª≠ tin nh·∫Øn
      const res = await fetch(`/admin/chat/messages/${currentUserId}`);
      const data = await res.json();

      chatBox.innerHTML = '';

      data.messages.forEach(msg => {
        const div = document.createElement('div');
        div.className =
          `alert ${msg.sender._id === adminId ? 'alert-primary' : 'alert-secondary'}`;
        div.innerText = `${msg.sender.username}: ${msg.content}`;
        chatBox.appendChild(div);
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    });
  });

  // ‚≠ê Nh·∫≠n tin nh·∫Øn realtime t·ª´ User
  adminSocket.on('newMessage', ({ senderId, message }) => {
  const badge = document.getElementById(`badge-${senderId}`);

  if (senderId !== currentUserId) {
    // ‚≠ê N·∫øu badge ·∫©n th√¨ set = 1
    if (badge.classList.contains('d-none')) {
      badge.innerText = 1;
      badge.classList.remove('d-none');
    } else {
      // ‚≠ê N·∫øu ƒë√£ c√≥ s·ªë ‚Üí tƒÉng
      badge.innerText = parseInt(badge.innerText) + 1;
    }

    playNotificationSound();
    showToast("C√≥ tin nh·∫Øn m·ªõi t·ª´ ng∆∞·ªùi d√πng");
    return;
  }

  // N·∫øu ƒëang m·ªü ƒë√∫ng ƒëo·∫°n chat ‚Üí hi·ªÉn th·ªã nh∆∞ b√¨nh th∆∞·ªùng
  const chatBox = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = 'alert alert-secondary';
  div.innerText = message;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
});

  // ‚≠ê G·ª≠i tin nh·∫Øn Admin ‚Üí User
  document.getElementById('sendBtn').addEventListener('click', () => {
    const input = document.getElementById('adminMessageInput');
    const message = input.value.trim();
    if (!message || !currentUserId) return;

    adminSocket.emit('chatMessage', {
      senderId: adminId,
      receiverId: currentUserId,
      message
    });

    const chatBox = document.getElementById('chatBox');
    const div = document.createElement('div');
    div.className = 'alert alert-primary';
    div.innerText = message;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;

    input.value = '';
  });

</script>
