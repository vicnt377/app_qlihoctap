{{!< admin}}
<title>Admin - Chat Box</title>

<div class="dashboard-header mb-4">
  <h3 class="dashboard-title text-2xl">Hộp thư & Trò chuyện</h3>
</div>

<main class="container-fluid">
  <div class="row">
    <!--  CỘT TRÁI: Danh sách người dùng -->
    <div class="col-md-4 border-end" style="max-height: 80vh; overflow-y: auto;">
      <h5 class="mb-3"><strong>Danh sách người dùng</strong></strong></h5>
      {{#if chats.length}}
        <ul class="list-group" id="userList">
          {{#each chats}}
            <li 
            class="list-group-item d-flex justify-content-between align-items-center user-item"
            data-user-id="{{this.user._id}}" 
            data-username="{{this.user.username}}">
            <div>
                <strong>{{this.user.username}}</strong><br>
                <small>{{this.lastMessage}}</small>
            </div>

            <!--  Badge thông báo -->
            <span
                class="badge bg-danger {{#unless this.unreadCount}}d-none{{/unless}}"
                id="badge-{{this.user._id}}">
                {{this.unreadCount}}
            </span>

            </li>

          {{/each}}
        </ul>
      {{else}}
        <p>Không có tin nhắn nào.</p>
      {{/if}}
    </div>

    <!--  CỘT PHẢI: Khung chat -->
    <div class="col-md-8">
      <div id="chatSection" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><strong>Trò chuyện với <span id="chatUsername"></span></strong></h5>
        </div>

        <div class="border rounded p-3 mb-3" id="chatBox" style="max-height: 60vh; overflow-y: auto;">
          <!-- Tin nhắn sẽ hiển thị ở đây -->
        </div>

        <div class="d-flex mt-3">
          <input type="text" id="adminMessageInput" class="form-control me-2" placeholder="Nhập tin nhắn...">
          <button id="sendBtn" class="btn btn-primary">Gửi</button>

        </div>
      </div>

      <div id="noChatSelected" class="text-muted text-center mt-5">
        <i class="far fa-comments fa-2x mb-2"></i>
        <p>Chọn một người dùng từ danh sách để bắt đầu trò chuyện </p>
      </div>
    </div>
  </div>
</main>


<script src="/socket.io/socket.io.js"></script>

<script>
  // SOCKET ADMIN CHAT
  const adminSocket = io();
  const adminId = '{{adminId}}';

  let currentUserId = null;

  // Đăng ký admin socket
  adminSocket.emit('register', { userId: adminId });

  // DOM
  const chatBox = document.getElementById('chatBox');
  const chatUsername = document.getElementById('chatUsername');
  const chatSection = document.getElementById('chatSection');
  const noChatSelected = document.getElementById('noChatSelected');
  const input = document.getElementById('adminMessageInput');
  const sendBtn = document.getElementById('sendBtn');

  //CHỌN USER ĐỂ CHAT
  document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', async () => {
      currentUserId = item.dataset.userId;
      const username = item.dataset.username;

      // Ẩn badge
      const badge = document.getElementById(`badge-${currentUserId}`);
      if (badge) {
        badge.classList.add('d-none');
        badge.innerText = '';
      }

      // Đánh dấu đã đọc
      fetch(`/admin/chat/mark-read/${currentUserId}`, { method: 'POST' });

      // Hiển thị giao diện chat
      chatUsername.innerText = username;
      noChatSelected.classList.add('d-none');
      chatSection.classList.remove('d-none');

      chatBox.innerHTML = '<p class="text-muted">Đang tải tin nhắn...</p>';

      // Lấy lịch sử tin nhắn
      const res = await fetch(`/admin/chat/messages/${currentUserId}`);
      const data = await res.json();

      chatBox.innerHTML = '';

      data.messages.forEach(msg => {
        appendMessage(
          msg.content,
          msg.sender._id === adminId ? 'admin' : 'user',
          msg.sender.username
        );
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    });
  });

  // GỬI TIN NHẮN
  function sendMessage() {
    const message = input.value.trim();
    if (!message || !currentUserId) return;

    adminSocket.emit('chatMessage', {
      senderId: adminId,
      receiverId: currentUserId,
      message
    });

    // Hiển thị ngay bên admin
    appendMessage(message, 'admin');

    input.value = '';
  }

  // Click nút gửi
  sendBtn.addEventListener('click', sendMessage);

  // Nhấn Enter để gửi
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });


  // NHẬN TIN NHẮN REALTIME


  adminSocket.on('newMessage', ({ senderId, message }) => {

    // Nếu KHÔNG phải user đang mở → tăng badge
    if (senderId !== currentUserId) {
      const badge = document.getElementById(`badge-${senderId}`);
      if (badge) {
        badge.innerText = badge.classList.contains('d-none')
          ? 1
          : parseInt(badge.innerText) + 1;
        badge.classList.remove('d-none');
      }

      if (typeof playNotificationSound === 'function') {
        playNotificationSound();
      }
      if (typeof showToast === 'function') {
        showToast('Có tin nhắn mới từ người dùng');
      }
      return;
    }

    // Đang mở đúng đoạn chat
    appendMessage(message, 'user');
  });

  // HIỂN THỊ TIN NHẮN
  function appendMessage(content, type, username = '') {
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${type}`;

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerText = content;

    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

</script>


