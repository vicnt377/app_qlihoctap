{{!< admin}}
<title>Admin-Video</title>

<div class="dashboard-header mb-4">
  <h3 class="dashboard-title text-2xl">
    <i class="fas fa-video me-2"></i>Quản Lý Khóa Học
  </h3>
</div>

<main class="container-fluid px-4">
  <!-- Thống kê nhanh nằm ngang -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Tổng video</small>
            <div class="fs-4 fw-bold mt-1">{{add videos.length allDeletedVideos.length}}</div>
          </div>
          <div class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-video text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Đang hoạt động</small>
            <div class="fs-4 fw-bold mt-1">{{videos.length}}</div>
          </div>
          <div class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-play-circle text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Không hoạt động</small>
            <div class="fs-4 fw-bold mt-1">{{allDeletedVideos.length}}</div>
          </div>
          <div class="rounded-circle bg-danger bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-trash text-danger fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Danh mục</small>
            <div class="fs-4 fw-bold mt-1">{{categories.length}}</div>
          </div>
          <div class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-folder text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Nút thêm video (căn phải) -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVideoModal">
      <i class="fas fa-plus me-1"></i> Thêm video mới
    </button>
  </div>

<!-- Modal -->
<div class="modal fade" id="addVideoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm video YouTube</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">YouTube ID</label>
          <input type="text" id="youtubeId" class="form-control" placeholder="VD: dQw4w9WgXcQ">
        </div>

        <div class="mb-3">
          <label class="form-label">Danh mục</label>
          <select id="category" class="form-select">
            <option value="">-- Chọn danh mục --</option>
            <option value="CNTT">CNTT</option>
            <option value="GD">Giáo dục</option>
            <option value="KT-TC">Kinh tế - Tài chính</option>
            <option value="NN">Ngoại ngữ</option>
            <option value="KD-QL">Kinh doanh - Quản lý</option>
          </select>
        </div>

        <div id="videoError" class="text-danger small d-none"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button class="btn btn-primary" onclick="createVideo()">Lưu video</button>
      </div>
    </div>
  </div>
</div>

  <!-- Tabs gọn gàng -->
  <ul class="nav nav-pills mb-3" id="videoTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#tabActive" data-bs-toggle="pill">
        Video hiện tại
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#tabDeleted" data-bs-toggle="pill">
        Đã xóa
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Tab: Video hiện tại -->
    <div class="tab-pane fade show active" id="tabActive">
      <div id="videoContainer">
        {{#if videos.length}}
          {{#each groupedActive}}
            {{#if @key}}
              <div class="category-section mb-4" data-category-section="{{@key}}">
                <!-- Tiêu đề danh mục -->
                <h5 class="fw-bold text-primary mb-3 border-bottom pb-2">
                  <i class="fas fa-folder-open me-2 text-warning"></i>
                  {{majorName @key}}
                  <span class="badge bg-light text-dark ms-2">
                    {{countVideosInCategory ../videos @key}} Video
                  </span>
                </h5>

                {{#if this.length}}
                  <div class="row g-3 video-list">
                    {{#each this}}
                      <div class="col-xl-3 col-lg-4 col-md-6 video-item" data-category="{{@../key}}">
                        <div class="card video-card h-100 border-0 shadow-sm hover-shadow">
                          <div class="position-relative">
                            <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                                alt="{{title}}"
                                class="card-img-top rounded-top"
                                style="height: 140px; object-fit: cover;"
                                onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                            {{#if duration}}
                              <span class="badge bg-dark position-absolute top-0 end-0 m-2">
                                <i class="fas fa-clock me-1"></i>{{duration}}
                              </span>
                            {{/if}}
                          </div>

                          <div class="card-body d-flex flex-column p-2">
                            <h6 class="card-title fw-bold mb-1 text-truncate" title="{{title}}">
                              {{title}}
                            </h6>

                            {{!-- <a href="https://youtube.com/watch?v={{youtubeId}}" --}}
                            <a href="/admin/videos/showdetail/{{_id}}" 
                              class="btn btn-outline-primary btn-sm mb-2">
                              Xem chi tiết
                            </a>

                            <div class="d-flex gap-1 mt-auto">
                              <button class="btn btn-warning btn-sm flex-fill btn-edit" data-id="{{_id}}">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-danger btn-sm flex-fill" onclick="confirmDelete('{{_id}}')">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    {{/each}}
                  </div>
                {{else}}
                  <div class="text-center text-muted small">Chưa có video trong danh mục này</div>
                {{/if}}
              </div>
            {{/if}}
          {{/each}}

          <!-- PHÂN TRANG NẰM Ở ĐÂY — NGOÀI VÒNG LẶP -->
          <div class="d-flex justify-content-center mt-4">
            <nav>
              <ul class="pagination">

                {{#if (gt currentPage 1)}}
                <li class="page-item">
                  <a class="page-link" href="?page={{subtract currentPage 1}}">&laquo;</a>
                </li>
                {{/if}}

                {{#each (rangeCategory 1 totalPages)}}
                <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                  <a class="page-link" href="?page={{this}}">{{this}}</a>
                </li>
                {{/each}}

                {{#if (lt currentPage totalPages)}}
                <li class="page-item">
                  <a class="page-link" href="?page={{add currentPage 1}}">&raquo;</a>
                </li>
                {{/if}}

              </ul>
            </nav>
          </div>
          <!-- END PHÂN TRANG -->

        {{else}}
          <div class="text-center py-5">
            <i class="fas fa-video fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Không có video nào</h5>
            <p class="text-muted">Hãy thêm video mới hoặc thay đổi bộ lọc</p>
          </div>
        {{/if}}
      </div>
    </div>

    <!-- Tab: Video đã xóa -->
    <div class="tab-pane fade" id="tabDeleted">
      <div id="deletedContainer">

        {{#if allDeletedVideos.length}}
          {{#each groupedDelete}}
            {{#if @key}}
            <div class="category-section mb-4">
              <h5 class="fw-bold text-danger mb-3 border-bottom pb-2">
                <i class="fas fa-folder-open me-2 text-warning"></i>
                {{majorName @key}}
                <span class="badge bg-light text-dark ms-2">
                  {{this.length}} Video
                </span>
              </h5>

              <div class="row g-3">
                {{#each this}}

                  <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card h-100 shadow-sm border-0 bg-light video-card">

                      <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                          class="card-img-top"
                          style="height:140px; object-fit:cover;">

                      <div class="card-body d-flex flex-column p-2">
                        <h6 class="card-title fw-bold mb-1 text-truncate text-muted" title="{{title}}">
                          {{title}}
                        </h6>

                        <div class="mt-auto">
                          <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm flex-fill btn-restore" data-id="{{_id}}">
                              <i class="fas fa-undo me-1"></i>Khôi phục
                            </button>

                            <button class="btn btn-danger btn-sm flex-fill btn-delete-permanent" data-id="{{_id}}">
                              <i class="fas fa-trash-alt me-1"></i>Xóa vĩnh viễn
                            </button>
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>

                {{/each}}
              </div>
            </div>
            {{/if}}
          {{/each}}

          <!-- PHÂN TRANG VIDEO ĐÃ XÓA -->
          <div class="d-flex justify-content-center mt-4">
            <nav>
              <ul class="pagination">

                {{#if (gt deletedPage 1)}}
                <li class="page-item">
                  <a class="page-link deleted-active" data-deleted-page="{{subtract deletedPage 1}}">
                    &laquo;
                  </a>
                </li>
                {{/if}}

                {{#each (rangeCategory 1 deletedTotalPages)}}
                <li class="page-item {{#if (eq this ../deletedPage)}}active{{/if}}">
                  <a class="page-link deleted-active" data-deleted-page="{{this}}">{{this}}</a>
                </li>
                {{/each}}

                {{#if (lt deletedPage deletedTotalPages)}}
                <li class="page-item">
                  <a class="page-link deleted-active" data-deleted-page="{{add deletedPage 1}}">
                    &raquo;
                  </a>
                </li>
                {{/if}}

              </ul>
            </nav>
          </div>

        {{else}}
          <div class="text-center py-5">
            <i class="fas fa-trash fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Không có video nào bị xóa</h5>
          </div>
        {{/if}}

      </div>
    </div>

  </div>
</main>
<!-- Modal chỉnh sửa video -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <form id="editVideoForm">
        <!-- Header -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Chỉnh sửa video
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-light">
          <input type="hidden" id="editVideoId">

          <div class="row g-3">
            <!-- YouTube ID -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">YouTube ID <span class="text-danger">*</span></label>
              <input type="text" id="editYoutubeId" name="youtubeId" class="form-control" required>
              <div class="form-text">Ví dụ: <code>dQw4w9WgXcQ</code></div>
            </div>

            <!-- Tiêu đề -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Tiêu đề <span class="text-danger">*</span></label>
              <input type="text" id="editTitle" name="title" class="form-control" required>
            </div>

            <!-- Danh mục -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Danh mục</label>
              <select id="editCategory" name="category" class="form-select">
                <option value="CNTT">Công nghệ thông tin</option>
                <option value="YT">Y tế</option>
                <option value="GD">Giáo dục</option>
                <option value="NN">Ngôn ngữ</option>
                <option value="KT-TC">Kinh tế - Tài chính</option>
                <option value="TN-MT">Tài nguyên - Môi trường</option>
                <option value="KD-QL">Kinh doanh - Quản lý</option>
                <option value="KT-XD">Kỹ thuật - Xây dựng</option>
                <option value="L-NV">Luật - Nhân văn</option>
                <option value="ST-NT">Sáng tạo - Nghệ thuật</option>
                <option value="DV-DL">Dịch vụ - Du lịch</option>
              </select>
            </div>

            <!-- Mô tả -->
            <div class="col-12">
              <label class="form-label fw-semibold">Mô tả</label>
              <textarea id="editDescription" name="description" class="form-control" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Hủy
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Lưu thay đổi
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{{!-- Thêm video mới --}}
<script>
async function createVideo() {
  const youtubeId = document.getElementById('youtubeId').value.trim();
  const category = document.getElementById('category').value;
  const errorBox = document.getElementById('videoError');

  errorBox.classList.add('d-none');

  if (!youtubeId || !category) {
    errorBox.textContent = 'Vui lòng nhập YouTube ID và chọn danh mục';
    errorBox.classList.remove('d-none');
    return;
  }

  try {
    const res = await fetch('/admin/videos/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ youtubeId, category })
    });

    const data = await res.json();

    if (!res.ok) {
      errorBox.textContent = data.message;
      errorBox.classList.remove('d-none');
      return;
    }

    alert('✅ Thêm video thành công');
    location.reload();
  } catch (err) {
    errorBox.textContent = 'Lỗi kết nối server';
    errorBox.classList.remove('d-none');
  }
}
</script>

{{!-- Phân trang active --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const videoContainer = document.getElementById('videoContainer');
  if (!videoContainer) return;

  function fetchVideos() {
    fetch('/admin/videos?ajax=1')
      .then(res => res.text())
      .then(html => {
        videoContainer.style.visibility = 'hidden';
        videoContainer.innerHTML = html;
        setTimeout(() => {
          videoContainer.style.visibility = 'visible';
        }, 100);
      })
      .catch(err => console.error('❌ Lỗi fetch videos:', err));
  }

  // Nếu sau này cần reload thủ công:
  // fetchVideos();
});
</script>

{{!-- Phân trang delete --}}
<script>
document.addEventListener("DOMContentLoaded", () => {

  // CLICK VÀO PHÂN TRANG TAB DELETED
  document.addEventListener("click", async (e) => {
    const button = e.target.closest(".deleted-active");
    if (!button) return;

    const page = button.dataset.deletedPage;
    const container = document.getElementById("deletedContainer");

    // CALL AJAX
    const res = await fetch(`/admin/videos?deletedPage=${page}&ajaxDeleted=1`);
    const data = await res.json();

    // RENDER HTML
    container.innerHTML = renderDeletedHTML(data);
  });

  // BUILD HTML CHO TAB DELETED (TƯƠNG TỰ HANDLEBARS)
  function renderDeletedHTML(data) {
    let html = "";

    for (let cat in data.groupedDelete) {
      let videos = data.groupedDelete[cat];

      html += `
      <div class="category-section mb-4">
        <h5 class="fw-bold text-danger mb-3 border-bottom pb-2">
          <i class="fas fa-folder-open me-2 text-warning"></i>
          ${majorName(cat)}
          <span class="badge bg-light text-dark ms-2">${videos.length} Video</span>
        </h5>
        <div class="row g-3">
      `;

      videos.forEach(v => {
        html += `
          <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm border-0 bg-light video-card">
              <img src="https://img.youtube.com/vi/${v.youtubeId}/hqdefault.jpg"
                   class="card-img-top" style="height:140px; object-fit:cover;">

              <div class="card-body d-flex flex-column p-2">
                <h6 class="card-title text-muted text-truncate" title="${v.title}">
                  ${v.title}
                </h6>

                <div class="mt-auto d-flex gap-2">
                  <button class="btn btn-success btn-sm flex-fill btn-restore" data-id="${v._id}">
                    <i class="fas fa-undo me-1"></i>Khôi phục
                  </button>

                  <button class="btn btn-danger btn-sm flex-fill btn-delete-permanent" data-id="${v._id}">
                    <i class="fas fa-trash-alt me-1"></i>Xóa vĩnh viễn
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div></div>`;
    }


    // PAGINATION
    html += `<div class="d-flex justify-content-center mt-4"><ul class="pagination">`;

    for (let i = 1; i <= data.deletedTotalPages; i++) {
      html += `
        <li class="page-item ${i == data.deletedPage ? "active" : ""}">
          <a class="page-link deleted-active" data-deleted-page="${i}">${i}</a>
        </li>
      `;
    }

    html += `</ul></div>`;
    return html;
  }

  // TÊN DANH MỤC
  function majorName(code) {
    const majors = {
      "CNTT": "Công nghệ thông tin",
      "DV-DL": "Dịch vụ - Du lịch",
      "GD": "Giáo dục",
      "YT": "Y tế",
      "NN": "Ngoại ngữ",
      "TN-MT": "Tự nhiên - Môi trường",
      "KT-TC": "Kinh tế - Tài chính",
      "KD-QL": "Kinh doanh - Quản lý",
      "KT-XD": "Kỹ thuật - Xây dựng",
      "L-NV": "Luật - Nhân văn",
      "ST-NT": "Sáng tạo - Nghệ thuật",
    };
    return majors[code] || code;
  }
});
</script>

{{!-- Chỉnh sửa video, xóa mềm, khôi phục --}}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // ========== FORM EDIT ==========
  const editForm = document.getElementById('editVideoForm');

  if (editForm) {
    editForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const id = document.getElementById('editVideoId').value;
      const youtubeId = document.getElementById('editYoutubeId').value.trim();
      const title = document.getElementById('editTitle').value.trim();
      const description = document.getElementById('editDescription').value.trim();
      const category = document.getElementById('editCategory').value.trim();

      try {
        const res = await fetch(`/admin/videos/${id}/edit`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ youtubeId, title, description, category }),
        });

        if (res.ok) {
          alert('✅ Cập nhật video thành công!');
          location.reload();
        } else {
          alert('❌ Có lỗi khi cập nhật video');
        }
      } catch (err) {
        console.error('Lỗi khi gửi form:', err);
        alert('❌ Lỗi kết nối tới máy chủ');
      }
    });
  }

  // ========== NÚT CHỈNH SỬA ==========
  document.querySelectorAll('.btn-edit').forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.dataset.id;
      if (!id) return;

      try {
        // Lấy dữ liệu video từ backend
        const res = await fetch(`/admin/videos/${id}`);
        if (!res.ok) throw new Error('Không lấy được dữ liệu video');

        const video = await res.json();

        // Đổ dữ liệu vào modal
        document.getElementById('editVideoId').value = video._id;
        document.getElementById('editYoutubeId').value = video.youtubeId || '';
        document.getElementById('editTitle').value = video.title || '';
        document.getElementById('editCategory').value = video.category || 'CNTT';
        document.getElementById('editDescription').value = video.description || '';

        // Nếu chưa có mô tả thì tự động lấy từ YouTube API
        if (!video.description && video.youtubeId) {
          try {
            const apiKey = 'AIzaSyCAsJisZhiEP6Haersjru30mcOnwZ3lLhs';
            const ytRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?id=${video.youtubeId}&part=snippet&key=${apiKey}`);
            const ytData = await ytRes.json();
            const ytDescription = ytData.items?.[0]?.snippet?.description || '';
            if (ytDescription) {
              document.getElementById('editDescription').value = ytDescription;
            }
          } catch (err) {
            console.warn('Không thể lấy mô tả từ YouTube:', err);
          }
        }

        // Mở modal
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();

      } catch (err) {
        console.error('❌ Lỗi khi mở modal chỉnh sửa:', err);
        alert('Không thể tải dữ liệu video!');
      }
    });
  });

  // ========== NÚT XÓA ==========
  window.confirmDelete = function (id) {
    if (confirm('Bạn có chắc chắn muốn xóa video này?')) {
      fetch(`/admin/videos/${id}/delete`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) location.reload();
          else alert('❌ Lỗi khi xóa video!');
        })
        .catch(err => {
          console.error('Lỗi xóa video:', err);
          alert('❌ Không thể kết nối máy chủ!');
        });
    }
  };

  // ========== KHÔI PHỤC VIDEO ==========
  document.querySelectorAll('.btn-restore').forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.dataset.id;
      if (confirm('Bạn có chắc muốn khôi phục video này không?')) {
        try {
          const res = await fetch(`/admin/videos/${id}/restore`, { method: 'PATCH' });
          if (res.ok) location.reload();
          else alert('❌ Khôi phục thất bại!');
        } catch (err) {
          console.error('Lỗi khôi phục:', err);
          alert('❌ Có lỗi xảy ra khi khôi phục!');
        }
      }
    });
  });
});
</script>

{{!-- xóa vĩnh viễn video --}}
<script>
document.addEventListener("click", async function (e) {
  const btn = e.target.closest(".btn-delete-permanent");
  if (!btn) return;

  const id = btn.dataset.id;

  if (!confirm("Bạn có chắc muốn xóa vĩnh viễn video này? Hành động không thể khôi phục!")) {
    return;
  }

  try {
    const res = await fetch(`/admin/videos/${id}/delete-permanent`, {
      method: "DELETE"
    });

    const data = await res.json();

    if (res.ok) {
      alert(data.message || "Đã xóa vĩnh viễn!");
      location.reload();
    } else {
      alert(data.message || "Xóa thất bại!");
    }
  } catch (err) {
    console.error(err);
    alert("Lỗi kết nối server!");
  }
});

</script>

