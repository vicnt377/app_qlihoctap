{{!< admin}}
<title>Admin-Video</title>

<div class="dashboard-header mb-4">
  <h3 class="dashboard-title text-2xl">
    <i class="fas fa-video me-2"></i>Qu·∫£n L√Ω Kh√≥a H·ªçc
  </h3>
</div>

<main class="container-fluid px-4">
  <!-- Th·ªëng k√™ nhanh n·∫±m ngang -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">T·ªïng kh√≥a h·ªçc</small>
            <div class="fs-4 fw-bold mt-1">{{add videos.length deletedVideos.length}}</div>
          </div>
          <div class="rounded-circle bg-primary bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-video text-primary fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">ƒêang ho·∫°t ƒë·ªông</small>
            <div class="fs-4 fw-bold mt-1">{{videos.length}}</div>
          </div>
          <div class="rounded-circle bg-success bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-play-circle text-success fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Kh√¥ng ho·∫°t ƒë·ªông</small>
            <div class="fs-4 fw-bold mt-1">{{deletedVideos.length}}</div>
          </div>
          <div class="rounded-circle bg-danger bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-trash text-danger fs-4"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">Danh m·ª•c</small>
            <div class="fs-4 fw-bold mt-1">{{categories.length}}</div>
          </div>
          <div class="rounded-circle bg-warning bg-opacity-10 p-3 d-flex align-items-center justify-content-center">
            <i class="fas fa-folder text-warning fs-4"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{!-- B·ªô l·ªçc v√† form th√™m video t·ª´ Youtube --}}
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <div class="row g-4 align-items-start">
        <!-- üîπ C·ªôt tr√°i: B·ªô l·ªçc -->
        <div class="col-md-6 border-end">
          <h6 class="fw-bold mb-3">B·ªô l·ªçc kh√≥a h·ªçc</h6>
          <form method="GET" action="/admin/videos" id="filterForm-search" class="row g-2 align-items-end">
            <div class="col-md-8">
              <input type="text" class="form-control form-control-sm" name="search" 
                    placeholder="üîç T√¨m ki·∫øm..." value="{{query.search}}">
            </div>
            <div class="col-md-4">
              <select id="category" name="category" class="form-select">
                <option value="all" {{#if (eq query.category 'all')}}selected{{/if}}>üìÅ T·∫•t c·∫£ danh m·ª•c</option>
                {{#each allMajors}}
                  <option value="{{@key}}" {{#if (eq ../query.category @key)}}selected{{/if}}>
                    {{this}}
                  </option>
                {{/each}}
              </select>
            </div>
          </form>
        </div>

        <!-- üîπ C·ªôt ph·∫£i: Form th√™m video -->
        <div class="col-md-6">
          <h6 class="fw-bold mb-3">Th√™m video t·ª´ YouTube</h6>
          <form id="youtubeSearchForm" class="row g-2 align-items-end">
            <div class="col-md-8">
              <input type="text" class="form-control form-control-sm" id="youtubeQuery" 
                    placeholder="Nh·∫≠p t·ª´ kh√≥a ho·∫∑c ID video YouTube">
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-danger btn-sm w-100">
                <i class="fab fa-youtube me-1"></i>T√¨m ki·∫øm
              </button>
            </div>
          </form>

          <!-- üî∏ K·∫øt qu·∫£ preview -->
          <div id="youtubeResult" class="row g-2 mt-2 d-none">
            <div class="col-md-3">
              <img id="ytThumbnail" src="" class="img-fluid rounded" style="height: 80px; object-fit: cover;">
            </div>
            <div class="col-md-9">
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="text" id="ytTitleInput" class="form-control form-control-sm" placeholder="Ti√™u ƒë·ªÅ">
                </div>
                <div class="col-md-3">
                  <input type="text" id="ytCategory" class="form-control form-control-sm" placeholder="Danh m·ª•c">
                </div>
                <div class="col-md-3">
                  <select class="form-select form-select-sm" id="ytLevel">
                    <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                    <option value="Trung b√¨nh" selected>Trung b√¨nh</option>
                    <option value="N√¢ng cao">N√¢ng cao</option>
                  </select>
                </div>
              </div>
              <div class="mt-2">
                <button class="btn btn-success btn-sm" id="ytAddBtn">
                  <i class="fas fa-plus me-1"></i>Th√™m v√†o h·ªá th·ªëng
                </button>
                <span id="ytMsg" class="ms-2"></span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Tabs g·ªçn g√†ng -->
  <ul class="nav nav-pills mb-3" id="videoTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#tabActive" data-bs-toggle="pill">
        <i class="fas fa-play-circle me-1"></i>Video hi·ªán t·∫°i
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#tabDeleted" data-bs-toggle="pill">
        <i class="fas fa-trash me-1"></i>ƒê√£ x√≥a
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Tab: Video hi·ªán t·∫°i -->
    <div class="tab-pane fade show active" id="tabActive">
      <div id="videoContainer">
        {{#if videos.length}}
          {{#each grouped}}
            {{#if @key}}
              <div class="category-section mb-4" data-category-section="{{@key}}">
                <!-- Ti√™u ƒë·ªÅ danh m·ª•c -->
                <h5 class="fw-bold text-primary mb-3 border-bottom pb-2">
                  <i class="fas fa-folder-open me-2 text-warning"></i>
                  {{majorName @key}}
                  <span class="badge bg-light text-dark ms-2">
                    {{countVideosInCategory ../videos @key}} Video
                  </span>
                </h5>

                {{#if this.length}}
                  <div class="row g-3 video-list">
                    {{#each this}}
                      <div class="col-xl-3 col-lg-4 col-md-6 video-item" data-category="{{@../key}}">
                        <div class="card video-card h-100 border-0 shadow-sm hover-shadow">
                          <div class="position-relative">
                            <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                                alt="{{title}}"
                                class="card-img-top rounded-top"
                                style="height: 140px; object-fit: cover;"
                                onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                            {{#if duration}}
                              <span class="badge bg-dark position-absolute top-0 end-0 m-2">
                                <i class="fas fa-clock me-1"></i>{{duration}}
                              </span>
                            {{/if}}
                          </div>

                          <div class="card-body d-flex flex-column p-2">
                            <h6 class="card-title fw-bold mb-1 text-truncate" title="{{title}}">
                              {{title}}
                            </h6>

                            <div class="d-flex justify-content-between text-muted small mb-2">
                              <span><i class="fas fa-users me-1"></i>{{video.students}}</span>
                              <span><i class="fas fa-star text-warning me-1"></i>{{video.rating}}</span>
                            </div>

                            <a href="https://youtube.com/watch?v={{youtubeId}}" 
                              target="_blank" 
                              class="btn btn-outline-primary btn-sm mb-2">
                              <i class="fab fa-youtube me-1"></i>Xem
                            </a>

                            <div class="d-flex gap-1 mt-auto">
                              <button class="btn btn-warning btn-sm flex-fill btn-edit" data-id="{{_id}}">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-danger btn-sm flex-fill" onclick="confirmDelete('{{_id}}')">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    {{/each}}
                  </div>
                {{else}}
                  <div class="text-center text-muted small">Ch∆∞a c√≥ video trong danh m·ª•c n√†y</div>
                {{/if}}
              </div>
            {{/if}}
          {{/each}}

          <!-- PH√ÇN TRANG N·∫∞M ·ªû ƒê√ÇY ‚Äî NGO√ÄI V√íNG L·∫∂P -->
          <div class="d-flex justify-content-center mt-4">
            <nav>
              <ul class="pagination">

                {{#if (gt currentPage 1)}}
                <li class="page-item">
                  <a class="page-link" href="?page={{subtract currentPage 1}}">&laquo;</a>
                </li>
                {{/if}}

                {{#each (rangeCategory 1 totalPages)}}
                <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
                  <a class="page-link" href="?page={{this}}">{{this}}</a>
                </li>
                {{/each}}

                {{#if (lt currentPage totalPages)}}
                <li class="page-item">
                  <a class="page-link" href="?page={{add currentPage 1}}">&raquo;</a>
                </li>
                {{/if}}

              </ul>
            </nav>
          </div>
          <!-- END PH√ÇN TRANG -->

        {{else}}
          <div class="text-center py-5">
            <i class="fas fa-video fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Kh√¥ng c√≥ video n√†o</h5>
            <p class="text-muted">H√£y th√™m video m·ªõi ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc</p>
          </div>
        {{/if}}
      </div>
    </div>

    <!-- Tab: Video ƒë√£ x√≥a -->
    <div class="tab-pane fade" id="tabDeleted">
      {{#if deletedVideos.length}}
        {{#each (groupBy deletedVideos 'category')}}
          {{#if @key}}
            <div class="category-section mb-4">
              <h5 class="fw-bold text-danger mb-3 border-bottom pb-2">
                <i class="fas fa-folder-open me-2 text-warning"></i>
                {{majorName @key}}
                <span class="badge bg-light text-dark ms-2">
                  {{countVideosInCategory ../deletedVideos @key}} Video
                </span>
              </h5>

              <div class="row g-3">
                {{#each this}}
                  <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card h-100 shadow-sm border-0 bg-light video-card">
                      <div class="position-relative">
                        <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                            class="card-img-top rounded-top"
                            alt="{{title}}"
                            style="height: 140px; object-fit: cover;"
                            onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                        <span class="badge position-absolute top-0 start-0 m-1 bg-danger">
                          <i class="fas fa-trash me-1"></i>ƒê√£ x√≥a
                        </span>
                        <span class="badge position-absolute top-0 end-0 m-1 bg-secondary">
                          {{majorName category}}
                        </span>
                      </div>

                      <div class="card-body d-flex flex-column p-2">
                        <h6 class="card-title fw-bold mb-1 text-truncate text-muted small" title="{{title}}">
                          {{title}}
                        </h6>

                        {{!-- <div class="row text-muted small mb-2">
                          <div class="col-6 text-center">
                            <i class="fas fa-tags mb-1 d-block"></i>
                            <span>{{majorName category}}</span>
                          </div>
                          <div class="col-6 text-center">
                            <i class="fas fa-star text-warning mb-1 d-block"></i>
                            <span>{{rating}}</span>
                          </div>
                        </div> --}}

                        <div class="mb-2">
                          <a href="https://youtube.com/watch?v={{youtubeId}}" target="_blank"
                            class="btn btn-outline-secondary btn-sm w-100">
                            <i class="fab fa-youtube me-1"></i>Xem tr√™n YouTube
                          </a>
                        </div>

                        <div class="mt-auto">
                          <button class="btn btn-success btn-sm w-100 btn-restore" data-id="{{_id}}">
                            <i class="fas fa-undo me-1"></i>Kh√¥i ph·ª•c
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                {{/each}}
              </div>
            </div>
          {{/if}}
        {{/each}}
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-trash fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o b·ªã x√≥a</h5>
          <p class="text-muted">T·∫•t c·∫£ kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</p>
        </div>
      {{/if}}
    </div>
  </div>
</main>

<!-- Modal ch·ªânh s·ª≠a video -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <form id="editVideoForm">
        <!-- Header -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a video
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-light">
          <input type="hidden" id="editVideoId">

          <div class="row g-3">
            <!-- YouTube ID -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">YouTube ID <span class="text-danger">*</span></label>
              <input type="text" id="editYoutubeId" name="youtubeId" class="form-control" required>
              <div class="form-text">V√≠ d·ª•: <code>dQw4w9WgXcQ</code></div>
            </div>

            <!-- Ti√™u ƒë·ªÅ -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
              <input type="text" id="editTitle" name="title" class="form-control" required>
            </div>

            <!-- Danh m·ª•c -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Danh m·ª•c</label>
              <select id="editCategory" name="category" class="form-select">
                <option value="CNTT">C√¥ng ngh·ªá th√¥ng tin</option>
                <option value="YT">Y t·∫ø</option>
                <option value="GD">Gi√°o d·ª•c</option>
                <option value="NN">Ng√¥n ng·ªØ</option>
                <option value="KT-TC">Kinh t·∫ø - T√†i ch√≠nh</option>
                <option value="TN-MT">T√†i nguy√™n - M√¥i tr∆∞·ªùng</option>
                <option value="KD-QL">Kinh doanh - Qu·∫£n l√Ω</option>
                <option value="KT-XD">K·ªπ thu·∫≠t - X√¢y d·ª±ng</option>
                <option value="L-NV">Lu·∫≠t - Nh√¢n vƒÉn</option>
                <option value="ST-NT">S√°ng t·∫°o - Ngh·ªá thu·∫≠t</option>
                <option value="DV-DL">D·ªãch v·ª• - Du l·ªãch</option>
              </select>
            </div>

            <!-- M√¥ t·∫£ -->
            <div class="col-12">
              <label class="form-label fw-semibold">M√¥ t·∫£</label>
              <textarea id="editDescription" name="description" class="form-control" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>H·ªßy
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>L∆∞u thay ƒë·ªïi
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('filterForm-search');
  const searchInput = form.querySelector('input[name="search"]');
  const categorySelect = form.querySelector('select[name="category"]');
  const videoContainer = document.getElementById('videoContainer');
  let typingTimer;

  function fetchVideos() {
    const params = new URLSearchParams(new FormData(form));
    const openItems = [...document.querySelectorAll('.accordion-collapse.show')].map(el => el.id);

    fetch(`/admin/videos?${params.toString()}&ajax=1`)
      .then(res => res.text())
      .then(html => {
        // T·∫°m ·∫©n container ƒë·ªÉ tr√°nh nh·∫•p nh√°y
        videoContainer.style.visibility = 'hidden';

        videoContainer.innerHTML = html;

        // M·ªü l·∫°i c√°c danh m·ª•c ƒëang m·ªü
        openItems.forEach(id => {
          const el = document.getElementById(id);
          if (el && !el.classList.contains('show')) {
            const collapse = new bootstrap.Collapse(el, { toggle: false });
            collapse.show();
          }
        });

        // Hi·ªán l·∫°i container sau 100ms
        setTimeout(() => (videoContainer.style.visibility = 'visible'), 100);
      })
      .catch(err => console.error('‚ùå L·ªói fetch videos:', err));
  }

  // G√µ t√¨m ki·∫øm t·ª± ƒë·ªông l·ªçc (debounce)
  searchInput.addEventListener('input', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(fetchVideos, 400);
  });

  // ƒê·ªïi danh m·ª•c l·ªçc ngay
  categorySelect.addEventListener('change', fetchVideos);
});


</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ========== FORM EDIT ==========
  const editForm = document.getElementById('editVideoForm');

  if (editForm) {
    editForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const id = document.getElementById('editVideoId').value;
      const youtubeId = document.getElementById('editYoutubeId').value.trim();
      const title = document.getElementById('editTitle').value.trim();
      const description = document.getElementById('editDescription').value.trim();
      const category = document.getElementById('editCategory').value.trim();

      try {
        const res = await fetch(`/admin/videos/${id}/edit`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ youtubeId, title, description, category }),
        });

        if (res.ok) {
          alert('‚úÖ C·∫≠p nh·∫≠t video th√†nh c√¥ng!');
          location.reload();
        } else {
          alert('‚ùå C√≥ l·ªói khi c·∫≠p nh·∫≠t video');
        }
      } catch (err) {
        console.error('L·ªói khi g·ª≠i form:', err);
        alert('‚ùå L·ªói k·∫øt n·ªëi t·ªõi m√°y ch·ªß');
      }
    });
  }

  // ========== N√öT CH·ªàNH S·ª¨A ==========
  document.querySelectorAll('.btn-edit').forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.dataset.id;
      if (!id) return;

      try {
        // L·∫•y d·ªØ li·ªáu video t·ª´ backend
        const res = await fetch(`/admin/videos/${id}`);
        if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu video');

        const video = await res.json();

        // ƒê·ªï d·ªØ li·ªáu v√†o modal
        document.getElementById('editVideoId').value = video._id;
        document.getElementById('editYoutubeId').value = video.youtubeId || '';
        document.getElementById('editTitle').value = video.title || '';
        document.getElementById('editCategory').value = video.category || 'CNTT';
        document.getElementById('editDescription').value = video.description || '';

        // N·∫øu ch∆∞a c√≥ m√¥ t·∫£ th√¨ t·ª± ƒë·ªông l·∫•y t·ª´ YouTube API
        if (!video.description && video.youtubeId) {
          try {
            const apiKey = 'AIzaSyCAsJisZhiEP6Haersjru30mcOnwZ3lLhs';
            const ytRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?id=${video.youtubeId}&part=snippet&key=${apiKey}`);
            const ytData = await ytRes.json();
            const ytDescription = ytData.items?.[0]?.snippet?.description || '';
            if (ytDescription) {
              document.getElementById('editDescription').value = ytDescription;
            }
          } catch (err) {
            console.warn('Kh√¥ng th·ªÉ l·∫•y m√¥ t·∫£ t·ª´ YouTube:', err);
          }
        }

        // M·ªü modal
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();

      } catch (err) {
        console.error('‚ùå L·ªói khi m·ªü modal ch·ªânh s·ª≠a:', err);
        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu video!');
      }
    });
  });

  // ========== N√öT X√ìA ==========
  window.confirmDelete = function (id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a video n√†y?')) {
      fetch(`/admin/videos/${id}/delete`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) location.reload();
          else alert('‚ùå L·ªói khi x√≥a video!');
        })
        .catch(err => {
          console.error('L·ªói x√≥a video:', err);
          alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß!');
        });
    }
  };

  // ========== KH√îI PH·ª§C VIDEO ==========
  document.querySelectorAll('.btn-restore').forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.dataset.id;
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c video n√†y kh√¥ng?')) {
        try {
          const res = await fetch(`/admin/videos/${id}/restore`, { method: 'PATCH' });
          if (res.ok) location.reload();
          else alert('‚ùå Kh√¥i ph·ª•c th·∫•t b·∫°i!');
        } catch (err) {
          console.error('L·ªói kh√¥i ph·ª•c:', err);
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi kh√¥i ph·ª•c!');
        }
      }
    });
  });
});
</script>
