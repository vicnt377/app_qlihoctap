{{!< admin}}
<title>Admin-Video</title>

<div class="dashboard-header mb-4">
  <h3 class="dashboard-title text-2xl">
    <i class="fas fa-video me-2"></i>Qu·∫£n L√Ω Kh√≥a H·ªçc
  </h3>
  <p class="text-muted mb-0">Qu·∫£n l√Ω v√† t·ªï ch·ª©c c√°c kh√≥a h·ªçc theo danh m·ª•c v√† c·∫•p ƒë·ªô</p>
</div>

<main class="container-fluid px-4">
  <!-- B·ªô l·ªçc v√† th·ªëng k√™ g·ªçp chung -->
  <div class="row g-3 mb-4">
    <!-- B·ªô l·ªçc -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          <form method="GET" action="/admin/videos" id="filterForm" class="row g-2 align-items-end">
            <div class="col-md-4">
              <input type="text" class="form-control form-control-sm" name="search" 
                     placeholder="üîç T√¨m ki·∫øm..." value="{{query.search}}">
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" name="category">
                <option value="all">üìÅ T·∫•t c·∫£ danh m·ª•c</option>
                {{#each categories}}
                  <option value="{{this}}" {{#if (eq ../query.category this)}}selected{{/if}}>{{this}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select form-select-sm" name="level">
                <option value="all">üìä T·∫•t c·∫£ c·∫•p ƒë·ªô</option>
                {{#each levels}}
                  <option value="{{this}}" {{#if (eq ../query.level this)}}selected{{/if}}>{{this}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary btn-sm w-100">
                <i class="fas fa-filter me-1"></i>L·ªçc
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Th·ªëng k√™ nhanh -->
    <div class="col-lg-4">
      <div class="row g-2">
        <div class="col-6">
          <div class="card bg-primary text-white text-center py-2">
            <small class="d-block">{{totalVideos}}</small>
            <small>Kh√≥a h·ªçc</small>
          </div>
        </div>
        <div class="col-6">
          <div class="card bg-success text-white text-center py-2">
            <small class="d-block">{{videos.length}}</small>
            <small>ƒêang ho·∫°t ƒë·ªông</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs g·ªçn g√†ng -->
  <ul class="nav nav-pills mb-3" id="videoTabs">
    <li class="nav-item">
      <a class="nav-link active" href="#tabActive" data-bs-toggle="pill">
        <i class="fas fa-play-circle me-1"></i>Kh√≥a h·ªçc hi·ªán t·∫°i
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#tabDeleted" data-bs-toggle="pill">
        <i class="fas fa-trash me-1"></i>ƒê√£ x√≥a
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Tab: Video hi·ªán t·∫°i -->
    <div class="tab-pane fade show active" id="tabActive">
      <!-- Form th√™m video YouTube -->
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-light py-2">
          <h6 class="mb-0"><i class="fab fa-youtube me-2 text-danger"></i>Th√™m kh√≥a h·ªçc t·ª´ YouTube</h6>
        </div>
        <div class="card-body p-3">
          <form id="youtubeSearchForm" class="row g-2 align-items-end">
            <div class="col-md-8">
              <input type="text" class="form-control form-control-sm" id="youtubeQuery" 
                     placeholder="Nh·∫≠p t·ª´ kh√≥a ho·∫∑c ID video YouTube">
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-danger btn-sm w-100">
                <i class="fab fa-youtube me-1"></i>T√¨m ki·∫øm
              </button>
            </div>
          </form>

          <!-- K·∫øt qu·∫£ preview -->
          <div id="youtubeResult" class="row g-2 mt-2 d-none">
            <div class="col-md-3">
              <img id="ytThumbnail" src="" class="img-fluid rounded" style="height: 80px; object-fit: cover;" />
            </div>
            <div class="col-md-9">
              <div class="row g-2">
                <div class="col-md-6">
                  <input type="text" id="ytTitleInput" class="form-control form-control-sm" placeholder="Ti√™u ƒë·ªÅ">
                </div>
                <div class="col-md-3">
                  <input type="text" id="ytCategory" class="form-control form-control-sm" placeholder="Danh m·ª•c">
                </div>
                <div class="col-md-3">
                  <select class="form-select form-select-sm" id="ytLevel">
                    <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                    <option value="Trung b√¨nh" selected>Trung b√¨nh</option>
                    <option value="N√¢ng cao">N√¢ng cao</option>
                  </select>
                </div>
              </div>
              <div class="mt-2">
                <button class="btn btn-success btn-sm" id="ytAddBtn">
                  <i class="fas fa-plus me-1"></i>Th√™m v√†o h·ªá th·ªëng
                </button>
                <span id="ytMsg" class="ms-2"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Danh s√°ch video theo danh m·ª•c v√† c·∫•p ƒë·ªô -->
      {{#if videos.length}}
        <div class="accordion" id="videoAccordion">
          {{#each (groupBy videos 'category')}}
          <div class="accordion-item border-0 shadow-sm mb-2">
            <h2 class="accordion-header" id="heading{{@index}}">
              <button class="accordion-button {{#unless @first}}collapsed{{/unless}} bg-gradient-primary text-white py-2" 
                      type="button" 
                      data-target="#collapse{{@index}}" 
                      data-expanded="{{#if @first}}true{{else}}false{{/if}}">
                <i class="fas {{#if @first}}fa-folder-open{{else}}fa-folder{{/if}} me-2"></i>
                <strong>{{@key}}</strong>
                <span class="badge bg-light text-primary ms-2">{{this.length}} kh√≥a h·ªçc</span>
              </button>
            </h2>
            
            <div id="collapse{{@index}}" 
                 class="accordion-collapse collapse {{#if @first}}show{{/if}}" 
                 aria-labelledby="heading{{@index}}" 
                 data-bs-parent="#videoAccordion">
              <div class="accordion-body p-0">
                <!-- Ph√¢n lo·∫°i theo c·∫•p ƒë·ªô -->
                {{#each (groupBy this 'level')}}
                <div class="level-section p-2 {{#if @first}}border-bottom{{/if}}">
                  <div class="d-flex align-items-center mb-2">
                    <span class="badge {{#if (eq @key 'C∆° b·∫£n')}}bg-success{{else if (eq @key 'Trung b√¨nh')}}bg-warning{{else}}bg-danger{{/if}} fs-6 px-2 py-1 me-2">
                      <i class="fas fa-signal me-1"></i>{{@key}}
                    </span>
                    <span class="text-muted small">{{this.length}} kh√≥a h·ªçc</span>
                  </div>
                  
                  <div class="row g-2">
                    {{#each this}}
                    <div class="col-xl-3 col-lg-4 col-md-6">
                      <div class="card h-100 shadow-sm border-0 hover-shadow video-card">
                        <div class="position-relative">
                          <img src="{{#if (thumbnailIsUrl this.thumbnail)}}{{this.thumbnail}}{{else if (eq this.thumbnail 'default.jpg')}}/img/thumbnails/default.jpg{{else if this.thumbnail}}/img/thumbnails/{{this.thumbnail}}{{else}}/img/thumbnails/default.jpg{{/if}}" 
                               class="card-img-top" alt="{{this.title}}" 
                               style="height: 120px; object-fit: cover;"
                               onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                          
                          <!-- Badge c·∫•p ƒë·ªô nh·ªè -->
                          <span class="badge position-absolute top-0 start-0 m-1 
                                       {{#if (eq this.level 'C∆° b·∫£n')}}bg-success{{else if (eq this.level 'Trung b√¨nh')}}bg-warning{{else}}bg-danger{{/if}}">
                            {{this.level}}
                          </span>
                          
                          <!-- Badge th·ªùi l∆∞·ª£ng -->
                          <span class="badge position-absolute top-0 end-0 m-1 bg-dark">
                            <i class="fas fa-clock me-1"></i>{{this.duration}}h
                          </span>
                        </div>
                        
                        <div class="card-body d-flex flex-column p-2">
                          <h6 class="card-title fw-bold mb-1 text-truncate small" title="{{this.title}}">
                            {{this.title}}
                          </h6>
                          
                          <div class="row text-muted small mb-2">
                            <div class="col-6 text-center">
                              <i class="fas fa-users mb-1 d-block"></i>
                              <span>{{this.students}} h·ªçc vi√™n</span>
                            </div>
                            <div class="col-6 text-center">
                              <i class="fas fa-star mb-1 d-block text-warning"></i>
                              <span>{{this.rating}}</span>
                            </div>
                          </div>
                          
                          <div class="mb-2">
                            <a href="https://youtube.com/watch?v={{this.youtubeId}}" target="_blank" 
                               class="btn btn-outline-primary btn-sm w-100">
                              <i class="fab fa-youtube me-1"></i>Xem
                            </a>
                          </div>
                          
                          <div class="d-flex gap-1 mt-auto">
                            <button class="btn btn-warning btn-sm flex-fill btn-edit" data-id="{{_id}}">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm flex-fill" onclick="confirmDelete('{{_id}}')">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    {{/each}}
                  </div>
                </div>
                {{/each}}
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-video fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o</h5>
          <p class="text-muted">H√£y th√™m kh√≥a h·ªçc m·ªõi ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc</p>
        </div>
      {{/if}}
    </div>

    <!-- Tab: Video ƒë√£ x√≥a -->
    <div class="tab-pane fade" id="tabDeleted">
      {{#if deletedVideos.length}}
        <div class="row g-3">
          {{#each deletedVideos}}
          <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card h-100 shadow-sm border-0 bg-light">
              <div class="position-relative">
                <img src="{{#if (thumbnailIsUrl this.thumbnail)}}{{this.thumbnail}}{{else if (eq this.thumbnail 'default.jpg')}}/img/thumbnails/default.jpg{{else if this.thumbnail}}/img/thumbnails/{{this.thumbnail}}{{else}}/img/thumbnails/default.jpg{{/if}}" 
                     class="card-img-top" alt="{{this.title}}" 
                     style="height: 120px; object-fit: cover; opacity: 0.7;"
                     onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                
                <!-- Badge ƒë√£ x√≥a -->
                <span class="badge position-absolute top-0 start-0 m-1 bg-danger">
                  <i class="fas fa-trash me-1"></i>ƒê√£ x√≥a
                </span>
                
                <!-- Badge danh m·ª•c -->
                <span class="badge position-absolute top-0 end-0 m-1 bg-secondary">
                  {{this.category}}
                </span>
              </div>
              
              <div class="card-body d-flex flex-column p-2">
                <h6 class="card-title fw-bold mb-1 text-truncate text-muted small" title="{{this.title}}">
                  {{this.title}}
                </h6>
                
                <div class="row text-muted small mb-2">
                  <div class="col-6 text-center">
                    <i class="fas fa-tags mb-1 d-block"></i>
                    <span>{{this.category}}</span>
                  </div>
                  <div class="col-6 text-center">
                    <i class="fas fa-signal mb-1 d-block"></i>
                    <span>{{this.level}}</span>
                  </div>
                </div>
                
                <div class="mb-2">
                  <a href="https://youtube.com/watch?v={{this.youtubeId}}" target="_blank" 
                     class="btn btn-outline-secondary btn-sm w-100">
                    <i class="fab fa-youtube me-1"></i>Xem tr√™n YouTube
                  </a>
                </div>
                
                <div class="mt-auto">
                  <button class="btn btn-success btn-sm w-100 btn-restore" data-id="{{_id}}">
                    <i class="fas fa-undo me-1"></i>Kh√¥i ph·ª•c
                  </button>
                </div>
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      {{else}}
        <div class="text-center py-5">
          <i class="fas fa-trash fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Kh√¥ng c√≥ kh√≥a h·ªçc n√†o b·ªã x√≥a</h5>
          <p class="text-muted">T·∫•t c·∫£ kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</p>
        </div>
      {{/if}}
    </div>
  </div>
</main>

<!-- Modal ch·ªânh s·ª≠a -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="editVideoForm">
        <div class="modal-header">
          <h5 class="modal-title"><strong>S·ª≠a Video</strong></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editVideoId">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">YouTube ID</label>
              <input type="text" name="youtubeId" class="form-control" id="editYoutubeId" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ti√™u ƒë·ªÅ</label>
              <input type="text" name="title" class="form-control" id="editTitle">
            </div>
            <div class="col-md-6">
              <label class="form-label">Danh m·ª•c</label>
              <input type="text" name="category" class="form-control" id="editCategory">
            </div>
            <div class="col-md-6">
              <label class="form-label">Tr√¨nh ƒë·ªô</label>
              <select name="level" class="form-select" id="editLevel">
                <option value="C∆° b·∫£n">C∆° b·∫£n</option>
                <option value="Trung b√¨nh">Trung b√¨nh</option>
                <option value="N√¢ng cao">N√¢ng cao</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">M√¥ t·∫£</label>
              <textarea name="description" class="form-control" rows="3" id="editDescription"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchForm = document.getElementById('youtubeSearchForm');
  const ytResult = document.getElementById('youtubeResult');
  const ytAddBtn = document.getElementById('ytAddBtn');

  let videoData = null;

  searchForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = document.getElementById('youtubeQuery').value.trim();
    if (!query) return;

    const res = await fetch(`/admin/videos/youtube-search?query=${encodeURIComponent(query)}`);
    const data = await res.json();

    if (data.video) {
      videoData = data.video;
      document.getElementById('ytThumbnail').src = videoData.thumbnail;
      document.getElementById('ytTitleInput').value = videoData.title;
      ytResult.classList.remove('d-none');
    } else {
      alert(data.message || 'Kh√¥ng t√¨m th·∫•y video');
      ytResult.classList.add('d-none');
    }
  });

  ytAddBtn.addEventListener('click', async () => {
    const titleInput = document.getElementById('ytTitleInput');
    const title = titleInput.value.trim() || videoData.title;
    const category = document.getElementById('ytCategory').value.trim();
    const level = document.getElementById('ytLevel').value;

    const msgDiv = document.getElementById('ytMsg');

    if (!title) {
      msgDiv.textContent = '‚ùå Kh√¥ng th·ªÉ l·∫•y ti√™u ƒë·ªÅ video';
      msgDiv.className = 'text-danger';
      return;
    }

    const payload = {
      ...videoData,
      title,
      category,
      level
    };

    const res = await fetch('/admin/videos/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (res.ok) {
      msgDiv.textContent = '‚úÖ Video ƒë√£ ƒë∆∞·ª£c th√™m!';
      msgDiv.className = 'text-success';
      location.reload();
    } else {
      msgDiv.textContent = '‚ùå ' + (result.message || 'Th√™m th·∫•t b·∫°i');
      msgDiv.className = 'text-danger';
    }
  });
});

function confirmDelete(id) {
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a video n√†y?')) {
    fetch(`/admin/videos/${id}/delete`, {
      method: 'DELETE'
    }).then(res => {
      if (res.ok) location.reload();
      else alert('L·ªói khi x√≥a!');
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const editButtons = document.querySelectorAll('.btn-edit');

  editButtons.forEach(button => {
    button.addEventListener('click', async (e) => {
      const card = e.target.closest('.video-card');
      const id = button.dataset.id;

      // L·∫•y th√¥ng tin t·ª´ card
      const title = card.querySelector('.card-title').textContent.trim();
      const category = card.closest('.accordion-item').querySelector('.accordion-button strong').textContent.trim();
      const level = card.querySelector('.badge:first-child').textContent.trim();
      const youtubeId = card.querySelector('a[href*="youtube.com"]').href.split('v=')[1];
      
      // ƒê·ªï d·ªØ li·ªáu v√†o form
      document.getElementById('editVideoId').value = id;
      document.getElementById('editYoutubeId').value = youtubeId;
      document.getElementById('editTitle').value = title;
      document.getElementById('editCategory').value = category;
      document.getElementById('editLevel').value = level;

      // G·ªçi API ƒë·ªÉ l·∫•y m√¥ t·∫£
      try {
        const apiKey = 'AIzaSyCAsJisZhiEP6Haersjru30mcOnwZ3lLhs';
        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?id=${youtubeId}&part=snippet,contentDetails&key=${apiKey}`;
        const res = await fetch(apiUrl);
        const data = await res.json();
        const video = data.items?.[0];
        if (video) {
          document.getElementById('editDescription').value = video.snippet.description || '';
        }
      } catch (err) {
        console.warn('Kh√¥ng th·ªÉ l·∫•y m√¥ t·∫£ t·ª´ API:', err);
        document.getElementById('editDescription').value = '';
      }

      const modal = new bootstrap.Modal(document.getElementById('editModal'));
      modal.show();
    });
  });

  // G·ª≠i form c·∫≠p nh·∫≠t
  document.getElementById('editVideoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('editVideoId').value;
    const payload = {
      title: document.getElementById('editTitle').value,
      description: document.getElementById('editDescription').value,
      youtubeId: document.getElementById('editYoutubeId').value,
      category: document.getElementById('editCategory').value,
      level: document.getElementById('editLevel').value,
    };

    const res = await fetch(`/admin/videos/${id}/edit`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (res.ok) location.reload();
    else alert('L·ªói khi c·∫≠p nh·∫≠t video!');
  });
});

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.btn-restore').forEach(button => {
    button.addEventListener('click', async () => {
      const id = button.getAttribute('data-id');
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c video n√†y kh√¥ng?')) {
        try {
          const res = await fetch(`/admin/videos/${id}/restore`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' }
          });

          if (res.ok) {
            location.reload();
          } else {
            alert('Kh√¥i ph·ª•c th·∫•t b·∫°i!');
          }
        } catch (err) {
          console.error('L·ªói kh√¥i ph·ª•c:', err);
          alert('C√≥ l·ªói x·∫£y ra!');
        }
      }
    });
  });
});

// B·ªô l·ªçc n√¢ng cao
document.addEventListener('DOMContentLoaded', function () {
  const filterForm = document.getElementById('filterForm');
  const searchInput = filterForm.querySelector('input[name="search"]');
  const categorySelect = filterForm.querySelector('select[name="category"]');
  const levelSelect = filterForm.querySelector('select[name="level"]');
  
  // T·ª± ƒë·ªông submit form khi thay ƒë·ªïi select
  categorySelect.addEventListener('change', function() {
    filterForm.submit();
  });
  
  levelSelect.addEventListener('change', function() {
    filterForm.submit();
  });
  
  // Debounce search input
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      filterForm.submit();
    }, 500);
  });
  
  // Loading state
  filterForm.addEventListener('submit', function() {
    const submitBtn = filterForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l·ªçc...';
    submitBtn.disabled = true;
    
    setTimeout(() => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }, 3000);
  });

  // X·ª≠ l√Ω toggle accordion
  const accordionButtons = document.querySelectorAll('.accordion-button');
  
  accordionButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const targetId = this.getAttribute('data-target');
      const targetCollapse = document.querySelector(targetId);
      const isExpanded = this.getAttribute('data-expanded') === 'true';
      
      if (isExpanded) {
        this.setAttribute('data-expanded', 'false');
        this.classList.add('collapsed');
        targetCollapse.classList.remove('show');
        
        const icon = this.querySelector('i');
        icon.className = icon.className.replace('fa-folder-open', 'fa-folder');
      } else {
        this.setAttribute('data-expanded', 'true');
        this.classList.remove('collapsed');
        targetCollapse.classList.add('show');
        
        const icon = this.querySelector('i');
        icon.className = icon.className.replace('fa-folder', 'fa-folder-open');
      }
    });
  });
});
</script>
