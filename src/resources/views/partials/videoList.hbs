{{!-- {{#if videos}}
  {{#each (groupBy videos 'category')}}
    {{#if @key}}
      <div class="category-section mb-4">
        <!-- Ti√™u ƒë·ªÅ danh m·ª•c -->
        <h5 class="fw-bold text-primary mb-3 border-bottom pb-2">
          <i class="fas fa-folder-open me-2 text-warning"></i>
          {{majorName @key}}
          <span class="badge bg-light text-dark ms-2">
            {{countVideosInCategory ../videos @key}} Video
          </span>
        </h5>

        <!-- Danh s√°ch video -->
        <div class="row g-3">
          {{#each this}}
            <div class="col-xl-3 col-lg-4 col-md-6">
              <div class="card video-card h-100 border-0 shadow-sm hover-shadow">
                <div class="position-relative">
                  <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                      alt="{{title}}"
                      class="card-img-top rounded-top"
                      style="height: 140px; object-fit: cover;"
                      onerror="this.src='/img/thumbnails/default.jpg'; this.onerror=null;">
                  {{#if duration}}
                    <span class="badge bg-dark position-absolute top-0 end-0 m-2">
                      <i class="fas fa-clock me-1"></i>{{duration}}
                    </span>
                  {{/if}}
                </div>

                <div class="card-body d-flex flex-column p-2">
                  <h6 class="card-title fw-bold text-truncate" title="{{title}}">
                    {{title}}
                  </h6>

                  <div class="d-flex justify-content-between text-muted small mb-2">
                    <span><i class="fas fa-users me-1"></i>{{students}}</span>
                    <span><i class="fas fa-star text-warning me-1"></i>{{rating}}</span>
                  </div>

                  <a href="https://youtube.com/watch?v={{youtubeId}}" target="_blank"
                    class="btn btn-outline-primary btn-sm mb-2">
                    <i class="fab fa-youtube me-1"></i>Xem
                  </a>

                  <!-- N√∫t ch·ªânh s·ª≠a v√† x√≥a -->
                  <div class="d-flex gap-1 mt-auto">
                    <button class="btn btn-warning btn-sm flex-fill btn-edit" data-id="{{_id}}">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm flex-fill" onclick="confirmDelete('{{_id}}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {{/each}}
        </div>
      </div>
    {{/if}}
  {{/each}}
{{else}}
  <div class="text-center text-muted py-5">
    <i class="fas fa-video-slash fa-3x mb-3"></i>
    <h6>Kh√¥ng c√≥ video n√†o ƒë·ªÉ hi·ªÉn th·ªã</h6>
    <p class="small">H√£y th√™m video m·ªõi ho·∫∑c thay ƒë·ªïi b·ªô l·ªçc ƒë·ªÉ xem k·∫øt qu·∫£.</p>
  </div>
{{/if}}

<!-- Modal ch·ªânh s·ª≠a video -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <form id="editVideoForm">
        <!-- Header -->
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a video
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-light">
          <input type="hidden" id="editVideoId">

          <div class="row g-3">
            <!-- YouTube ID -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">YouTube ID <span class="text-danger">*</span></label>
              <input type="text" id="editYoutubeId" name="youtubeId" class="form-control" required>
              <div class="form-text">V√≠ d·ª•: <code>dQw4w9WgXcQ</code></div>
            </div>

            <!-- Ti√™u ƒë·ªÅ -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Ti√™u ƒë·ªÅ <span class="text-danger">*</span></label>
              <input type="text" id="editTitle" name="title" class="form-control" required>
            </div>

            <!-- Danh m·ª•c -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Danh m·ª•c</label>
              <select id="editCategory" name="category" class="form-select">
                <option value="CNTT">C√¥ng ngh·ªá th√¥ng tin</option>
                <option value="YT">Y t·∫ø</option>
                <option value="GD">Gi√°o d·ª•c</option>
                <option value="NN">Ng√¥n ng·ªØ</option>
                <option value="KT-TC">Kinh t·∫ø - T√†i ch√≠nh</option>
                <option value="TN-MT">T√†i nguy√™n - M√¥i tr∆∞·ªùng</option>
                <option value="KD-QL">Kinh doanh - Qu·∫£n l√Ω</option>
                <option value="KT-XD">K·ªπ thu·∫≠t - X√¢y d·ª±ng</option>
                <option value="L-NV">Lu·∫≠t - Nh√¢n vƒÉn</option>
                <option value="ST-NT">S√°ng t·∫°o - Ngh·ªá thu·∫≠t</option>
                <option value="DV-DL">D·ªãch v·ª• - Du l·ªãch</option>
              </select>
            </div>

            <!-- M√¥ t·∫£ -->
            <div class="col-12">
              <label class="form-label fw-semibold">M√¥ t·∫£</label>
              <textarea id="editDescription" name="description" class="form-control" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>H·ªßy
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>L∆∞u thay ƒë·ªïi
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('filterForm-search');
  const searchInput = form?.querySelector('input[name="search"]');
  const categorySelect = form?.querySelector('select[name="category"]');
  const videoContainer = document.getElementById('videoContainer');
  let typingTimer;
  
  function attachEditButtonEvents() {
    document.querySelectorAll('.btn-edit').forEach(button => {
      button.addEventListener('click', async () => {
        const id = button.dataset.id;
        if (!id) return;
        try {
          const res = await fetch(`/admin/videos/${id}`);
          if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu video');
          const video = await res.json();

          document.getElementById('editVideoId').value = video._id;
          document.getElementById('editYoutubeId').value = video.youtubeId || '';
          document.getElementById('editTitle').value = video.title || '';
          document.getElementById('editCategory').value = video.category || 'CNTT';
          document.getElementById('editDescription').value = video.description || '';

          const modal = new bootstrap.Modal(document.getElementById('editModal'));
          modal.show();
        } catch (err) {
          console.error('‚ùå L·ªói khi m·ªü modal ch·ªânh s·ª≠a:', err);
        }
      });
    });
  }


  // üîπ H√†m t·∫£i l·∫°i danh s√°ch video b·∫±ng AJAX
  function fetchVideos() {
    const params = new URLSearchParams(new FormData(form));
    fetch(`/admin/videos?${params.toString()}&ajax=1`)
      .then(res => res.text())
      .then(html => {
        videoContainer.innerHTML = html;
        attachEditButtonEvents();

      })
      .catch(err => console.error('‚ùå L·ªói fetch videos:', err));
  }

  // üîπ T√¨m ki·∫øm t·ª± ƒë·ªông l·ªçc (debounce)
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(fetchVideos, 400);
    });
  }

  // üîπ ƒê·ªïi danh m·ª•c l·ªçc ngay
  if (categorySelect) categorySelect.addEventListener('change', fetchVideos);

  // üîπ G·∫Øn n√∫t x√≥a
  attachDeleteButtons();
});

// üü¶ H√ÄM X·ª¨ L√ù X√ìA VIDEO
function attachDeleteButtons() {
  window.confirmDelete = function (id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a video n√†y?')) {
      fetch(`/admin/videos/${id}/delete`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) location.reload();
          else alert('‚ùå L·ªói khi x√≥a video!');
        })
        .catch(err => {
          console.error('L·ªói x√≥a video:', err);
          alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß!');
        });
    }
  };
}

// üü® S·ª∞ KI·ªÜN CLICK EDIT VIDEO (event delegation)
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-edit');
  if (!btn) return;

  console.log('üü¢ Click edit:', btn.dataset.id); // Ki·ªÉm tra click

  const id = btn.dataset.id;
  if (!id) return;

  try {
    const res = await fetch(`/admin/videos/${id}`);
    if (!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu video');
    const video = await res.json();

    // G√°n d·ªØ li·ªáu v√†o modal
    document.getElementById('editVideoId').value = video._id || '';
    document.getElementById('editYoutubeId').value = video.youtubeId || '';
    document.getElementById('editTitle').value = video.title || '';
    document.getElementById('editCategory').value = video.category || '';
    document.getElementById('editDescription').value = video.description || '';

    // N·∫øu ch∆∞a c√≥ m√¥ t·∫£ ‚Üí l·∫•y t·ª´ YouTube
    if (!video.description && video.youtubeId) {
      const apiKey = 'AIzaSyCAsJisZhiEP6Haersjru30mcOnwZ3lLhs';
      const ytRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?id=${video.youtubeId}&part=snippet&key=${apiKey}`);
      const ytData = await ytRes.json();
      const ytDescription = ytData.items?.[0]?.snippet?.description || '';
      if (ytDescription) {
        document.getElementById('editDescription').value = ytDescription;
      }
    }

    // M·ªü modal
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();

  } catch (err) {
    console.error('‚ùå L·ªói khi m·ªü modal ch·ªânh s·ª≠a:', err);
    alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu video!');
  }
});
</script>

 --}}
