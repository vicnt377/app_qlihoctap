<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<h2 class="dashboard-title mb-4">üìÖ L·ªãch H·ªçc</h2>

<main class="col-md-9 col-lg-10 content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSemesterModal">
            ‚ûï Th√™m h·ªçc k·ª≥ m·ªõi
        </button>
    </div>
    <!-- Modal th√™m h·ªçc k·ª≥ -->
    <div class="modal fade" id="addSemesterModal" tabindex="-1" aria-labelledby="addSemesterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form method="POST" action="/semester/add" class="modal-content">
        <div class="modal-header">
            <h5 style="color: black;" class="modal-title" id="addSemesterModalLabel">‚ûï Th√™m h·ªçc k·ª≥ m·ªõi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
            <label style="color: black;" for="tenHocKy" class="form-label" >T√™n h·ªçc k·ª≥</label>
            <select name="tenHocKy" class="form-control">

                <option value="" disabled selected>-- Ch·ªçn H·ªçc K·ª≥ --</option>
                <option value="H·ªçc K·ª≥ 1">H·ªçc K·ª≥ 1</option>
                <option value="H·ªçc K·ª≥ 2">H·ªçc K·ª≥ 2</option>
                <option value="H·ªçc K·ª≥ 3">H·ªçc K·ª≥ 3</option>
            </select>
            </div>
            <div class="mb-3">
            <label style="color: black;" for="namHoc" class="form-label">NƒÉm h·ªçc</label>
            <input type="text" class="form-control" name="namHoc" placeholder="VD: 2012 - 2022" required>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-success">L∆∞u</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        </div>
        </form>
        <div id="alertBox" class="mt-3"></div>
    </div>
    </div>

    <!-- B·ªô l·ªçc h·ªçc k·ª≥ + nƒÉm h·ªçc -->
    <form method="GET" action="/semester" class="row g-4 mb-4">
        <div class="col-md-4">
            <select name="year" class="form-select" required>
                <option value="T·∫•t c·∫£" {{#if (eq selectedYear 'T·∫•t c·∫£')}}selected{{/if}}>T·∫•t c·∫£</option>
                {{#each years}}
                <option value="{{this}}" {{#ifEquals ../selectedYear this}}selected{{/ifEquals}}>{{this}}</option>
                {{/each}}
                
            </select>
        </div>
        <div class="col-md-4">
            <select name="semester" class="form-select" required>
                <option value="T·∫•t c·∫£" {{#if (eq selectedSemester 'T·∫•t c·∫£')}}selected{{/if}}>T·∫•t c·∫£</option>
                {{#each semestersList}}
                <option value="{{this}}" {{#ifEquals ../selectedSemester this}}selected{{/ifEquals}}>{{this}}</option>
                {{/each}}
                
            </select>
        </div>
        <div class="col-md-4">
            <button class="btn btn-success"> üîç </button>
        </div>

    </form>

    <!-- Danh s√°ch l·ªãch h·ªçc -->

        <div class="card p-4">
            {{#if classesGroupedBySemester.length}}
                {{#each classesGroupedBySemester}}
                    <h5 class=" text-primary">{{tenHocKy}} - {{namHoc}}</h5>
                    <ul class="list-group mb-3">
                        {{#each scores}}
                        <li class="list-group-item">
                            üìå {{thu}} - {{HocPhan.tenHocPhan}} ({{gioHoc}})
                        </li>
                        {{/each}}
                    </ul>
                {{/each}}
            {{else}}
                <li class="list-group-item text-muted">Kh√¥ng c√≥ l·ªãch h·ªçc cho h·ªçc k·ª≥ n√†y.</li>
            {{/if}}

        </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('#addSemesterForm');
  const messageBox = document.querySelector('#messageBox');
  const semesterSelect = document.querySelector('select[name="semester"]');
  const yearSelect = document.querySelector('select[name="year"]');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const tenHocKy = formData.get('hocKy');
    const namHoc = formData.get('namHoc');

    try {
      const res = await fetch('/semester/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tenHocKy, namHoc })
      });

      const data = await res.json();

      if (!res.ok) {
        messageBox.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        return;
      }

      // Hi·ªÉn th·ªã th√¥ng b√°o
      messageBox.innerHTML = `<div class="alert alert-success">${data.message}</div>`;

      // G·ª≠i l·∫°i GET request ƒë·ªÉ l·∫•y l·ªãch h·ªçc m·ªõi
      const response = await fetch(`/semester?year=${encodeURIComponent(namHoc)}&semester=${encodeURIComponent(tenHocKy)}`);
      const html = await response.text();

      // C·∫≠p nh·∫≠t l·∫°i ph·∫ßn n·ªôi dung c·ªßa danh s√°ch h·ªçc k·ª≥
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newContent = doc.querySelector('.card.p-4'); // l·∫•y ph·∫ßn n·ªôi dung danh s√°ch h·ªçc k·ª≥
      document.querySelector('.card.p-4').replaceWith(newContent);

      // ƒê√≥ng modal v√† reset form
      form.reset();
      const modalEl = document.getElementById('addSemesterModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

    } catch (err) {
      console.error('L·ªói:', err);
      messageBox.innerHTML = `<div class="alert alert-danger">‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.</div>`;
    }
  });
});
</script>





</main>
