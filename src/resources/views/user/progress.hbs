<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h3 fw-bold mb-2">
          Tiến Độ Học Tập
        </h1>
        <p class=" mb-0">Theo dõi tiến độ học tập của bạn</p>
      </div>
    </div>
  </div>
</div>
<main class="container-fluid px-4 py-3">


  <div class="alert alert-{{progressStatus.color}}">
    <p><strong>Trình độ: </strong>{{yearText}}</p>
    <strong>Tiến độ học tập:</strong>
    {{progressStatus.label}} <br>
    {{!-- Đã tích lũy {{totalCredits}} /
    {{multiply semesterCount 20}} tín chỉ
    ({{progressStatus.ratio}}%) --}}
  </div>

  <div class="row g-4 align-items-stretch">

    <!-- GPA -->
    <div class="col-md-6">
      <div class="h-100">
        <canvas id="gpaChart"></canvas>
      </div>
    </div>

    <!-- Tín chỉ -->
    <div class="col-md-6">
      <div class="h-100">
        <canvas id="creditLineChart"></canvas>
      </div>
    </div>

    <!-- Bên trái: 2 biểu đồ tròn -->
    <div class="col-md-6 d-flex justify-content-center">
      <div class="d-flex flex-column gap-4">
        <div class="pie-wrapper">
          <canvas id="gradePieChart"></canvas>
        </div>
        <div class="pie-wrapper">
          <canvas id="gradeCreditPieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bên phải: điểm các môn -->
    <div class="col-md-6">
      <div class="h-100">
        <canvas id="subjectScoreChart"></canvas>
      </div>
    </div>

  </div>
</main>


<style>
.chart-card {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.pie-wrapper {
  width: 240px;
  height: 240px;
  margin: 0 auto;
}

.pie-wrapper canvas {
  width: 100% !important;
  height: 100% !important;
}

#subjectScoreChart {
  min-height: 400px;
}

</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{!-- Biểu đồ điểm trung bình và tích lũy qua các học kỳ --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('gpaChart');
  if (!canvas) return;

  const diemTBHocKy = {{{diemTBHocKy}}};
  const diemTBTichLuy = {{{diemTBTichLuy}}};

  new Chart(canvas, {
    data: {
      labels: {{{labels}}},
      datasets: [
        {
          type: 'bar',
          label: 'Điểm trung bình học kỳ',
          data: diemTBHocKy
        },
        {
          type: 'line',
          label: 'Điểm trung bình tích lũy',
          data: diemTBTichLuy,
          tension: 0.4
        }
      ]
    },
    options: {
      scales: {
        y: {
          min: 0,
          max: 4,
          ticks: {
            stepSize: 0.5,
            callback: v => v.toFixed(1)
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Điểm trung bình và tích lũy qua các học kỳ (thang 4)',
          font: {
            size: 20,        
            weight: 'bold'
          }
        }
      }
    }
  });
});
</script>


{{!-- Biểu đồ tín chỉ tích lũy qua các học kỳ --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('creditLineChart');
  if (!canvas) return;

  new Chart(canvas, {
    data: {
      labels: {{{labels}}},
      datasets: [
        {
          type: 'bar',
          label: 'Số tín chỉ trong học kỳ',
          data: {{{tinChiHocKy}}},
        },
        {
          type: 'line',
          label: 'Tổng số tín chỉ',
          data: {{{tongTinChi}}},
          tension: 0.4,
          borderColor: '#4CAF50',          
          backgroundColor: '#4CAF50',      
          pointBackgroundColor: '#4CAF50',
          pointBorderColor: '#4CAF50',
          borderWidth: 2
        }
      ]
    },
    options: {
      scales: {
        y: {
          min: 0,
          max: 160,
          ticks: {
            stepSize: 20,
          }
        }
      },      
      plugins: {
        title: {
          display: true,
          text: 'Số tín chỉ tích lũy qua các học kỳ',
          font: {
            size: 20,        
            weight: 'bold'
          }
        }
      }
    }
  });
});
</script>

{{!-- Biểu đồ tròn điểm chữ --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('gradePieChart');
  if (!canvas) return;

  const diemChuStats = {{{json diemChuStats}}};

  new Chart(canvas, {
    type: 'pie',
    data: {
      labels: Object.keys(diemChuStats),
      datasets: [{
        data: Object.values(diemChuStats),
        backgroundColor: [
            '#4CAF50', // A
            '#1976D2', // B+  (xanh dương đậm)
            '#2196F3', // B
            '#F9A825', // C+  (vàng đậm)
            '#FFC107', // C
            '#FB8C00', // D+  (cam đậm)
            '#FF9800', // D
            '#E53935'  // F  (đỏ)
        ]
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: 'Thống kê theo điểm chữ',
          font: {
            size: 18,
            weight: 'bold'
          }
        }
      }
    }
  });
});
</script>

{{!-- Biểu đồ tròn điểm chữ × tín chỉ --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('gradeCreditPieChart');
  if (!canvas) return;

  const diemChuTinChi = {{{diemChuTinChi}}};

  new Chart(canvas, {
    type: 'pie',
    data: {
      labels: Object.keys(diemChuTinChi),
      datasets: [{
        data: Object.values(diemChuTinChi),
        backgroundColor: [
            '#4CAF50', // A
            '#1976D2', // B+  (xanh dương đậm)
            '#2196F3', // B
            '#F9A825', // C+  (vàng đậm)
            '#FFC107', // C
            '#FB8C00', // D+  (cam đậm)
            '#FF9800', // D
            '#E53935'  // F  (đỏ)
        ]
      }]
    },
    options: {
      plugins: {
        title: {
          display: true,
          text: 'Thống kê theo điểm chữ × tín chỉ',
          font: {
            size: 18,
            weight: 'bold'
          }
        }
      }
    }
  });
});
</script>

{{!-- Biểu đồ điểm các môn học --}}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('subjectScoreChart');
  if (!canvas) return;

  // Labels TRƯỚC
  const labels = [
    {{#each scores}}
      "{{HocPhan.tenHocPhan}}",
    {{/each}}
  ];

  //  Sau đó mới set height
  const rowHeight = 15; 
  canvas.height = Math.max(400, labels.length * rowHeight);

  const rawData = [
    {{#each scores}}
      {{diemSo}},
    {{/each}}
  ];

  //  Chia điểm đạt / rớt
  const diemDat = rawData.map(d => d > 4 ? d : null);
  const diemRot = rawData.map(d => d <= 4 ? d : null);

  new Chart(canvas, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Đạt',
          data: diemDat,
          backgroundColor: 'rgba(33, 150, 243, 0.8)',
          categoryPercentage: 0.8,
          barPercentage: 0.9
        },
        {
          label: 'Rớt',
          data: diemRot,
          backgroundColor: 'rgba(244, 67, 54, 0.85)',
          categoryPercentage: 0.8,
          barPercentage: 0.9,
          grouped: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: {
          min: 0,
          max: 10,
          ticks: {
            stepSize: 1
          }
        },
        y: {
          ticks: {
            font: {
              size: 7
            }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'Điểm các môn (Đạt / Rớt)',
          font: {
            size: 20,
            weight: 'bold'
          }
        },
        legend: {
          labels: {
            font: {
              size: 12
            }
          }
        }
      }
    }

  });
});
</script>


