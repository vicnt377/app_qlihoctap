
<!-- Header Section with Gradient Background (reuse document header styles) -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
         <h1 class="h2 fw-bold mb-2">
           Trang Chủ
         </h1>
         <div class="welcome-section">
           <div class="welcome-text mb-2">
             {{!-- <span class="text-white fs-5">Chào mừng trở lại, </span> --}}
             <span class=" fw-bold fs-5">{{user.username}}</span>
             <span class="fs-5">!</span>
           </div>
           <p class="mb-0 fs-6">Chúc bạn có một ngày học hiệu quả</p>
         </div>
      </div>
      {{!-- <div class="col-md-4">
        <div class="row g-2">
          <div class="col-4">
            <div class="stats-card p-2 text-center">
              <div class="stats-item">
                <i class="fas fa-award text-orange mb-1"></i>
                <div class="stats-number small">{{totalCredits}}</div>
                <div class="stats-label small">Tín chỉ</div>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="stats-card p-2 text-center">
              <div class="stats-item">
                <i class="fas fa-video text-orange mb-1"></i>
                <div class="stats-number small">
                  {{videoCount}}
                </div>
                <div class="stats-label small">Video</div>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="stats-card p-2 text-center">
              <div class="stats-item">
                <i class="fas fa-file-alt text-orange mb-1"></i>
                <div class="stats-number small">{{recentDocsCount}}</div>
                <div class="stats-label small">Tài liệu mới</div>
              </div>
            </div>
          </div>
        </div>
      </div> --}}
    </div>
  </div>
</div>

<main class="container-fluid px-4">
  <!-- Hàng thẻ truy cập nhanh (trái) + tài liệu mới (trái) và biểu đồ (phải) -->
  <div class="row g-3 mb-3">
    <!-- Cột trái -->
    <div class="col-lg-5 d-flex flex-column gap-3">
      <!-- Truy cập nhanh -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-2">
          <h6 class="mb-0">Truy cập nhanh</h6>
        </div>
        <div class="card-body pt-3 pb-2">
          <div class="row row-cols-2 row-cols-md-3 g-2 text-center">
            {{!-- <a href="/course" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-book fa-lg text-primary mb-2"></i>
                <div class="small">Học Phần</div>
              </div>
            </a> --}}
            <a href="/document" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-file fa-lg text-success mb-2"></i>
                <div class="small">Tài Liệu</div>
              </div>
            </a>
            <a href="/progress" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-chart-line fa-lg text-warning mb-2"></i>
                <div class="small">Tiến Độ</div>
              </div>
            </a>
            <a href="/semester" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-calendar-alt fa-lg text-danger mb-2"></i>
                <div class="small">Học Kỳ</div>
              </div>
            </a>
            <a href="/score" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-graduation-cap fa-lg text-secondary mb-2"></i>
                <div class="small">Kết Quả</div>
              </div>
            </a>
            <a href="/video" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-video fa-lg" style="color: #cf4408;"></i>
                <div class="small">Video</div>
              </div>
            </a>
            <a href="/chat" class="col text-decoration-none text-dark">
              <div class="p-3 border rounded shadow-sm bg-light hover-shadow">
                <i class="fas fa-comment-dots fa-lg text-primary"></i>
                <div class="small">Hỏi Đáp</div>
              </div>
            </a>
          </div>
        </div>
      </div>

      <!-- Các tài liệu mới -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-2">
          <h6 class="mb-0">Các tài liệu mới</h6>
        </div>
        <div class="card-body p-0">
          {{#if recentDocs.length}}
            <div style="max-height: 250px; overflow-y: auto;">   <!-- ✅ cuộn dọc -->
              <ul class="list-group list-group-flush">
                {{#each recentDocs}}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <i class="{{getFileIcon this}} me-2"></i>
                      <strong>{{this.title}}</strong>
                      <small class="text-muted"> - {{this.user.username}}</small>
                      <div class="small text-muted">
                        {{formatDate this.createdAt}} • {{formatFileSize this.fileSize}}
                      </div>
                    </div>
                    <div>
                      <a href="/document/preview/{{this._id}}" 
                        class="btn btn-sm btn-outline-orange" target="_blank">
                        Xem
                      </a>
                    </div>
                  </li>
                {{/each}}
              </ul>
            </div>
          {{else}}
            <div class="text-center py-4">
              <div class="empty-state">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <h6 class="text-muted mb-2">Không có tài liệu mới nào được chia sẻ trong 3 ngày qua</h6>
                <p class="text-muted mb-3 small">Các tài liệu public mới sẽ hiển thị tại đây</p>
                <a href="/document" class="btn btn-outline-orange btn-sm">
                  Xem tài liệu
                </a>
              </div>
            </div>
          {{/if}}
        </div>
      </div>
    </div>

    <!-- Cột phải - Thống kê học tập -->
    <div class="col-lg-7">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-gradient-gray text-white py-2">
          <h6 class="mb-0">Thống kê học tập</h6>
        </div>
        <div class="card-body p-4" style="height: 320px;">
          <p class="mb-3">
            <strong>{{totalCredits}} / {{maxCredits}} tín chỉ đã hoàn thành</strong>
          </p>
          <canvas style="width:100%; height:100%;" id="creditChart"></canvas>
          {{#if totalCreditsExceeded}}
            <div class="alert alert-warning mt-3 mb-0" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>Số tín chỉ vượt quá giới hạn!
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>

  <!-- Các video đã quan tâm -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-gradient-gray text-white py-2">
      <h6 class="mb-0">Các video đã quan tâm</h6>
    </div>

    <div class="card-body p-3">
      {{#if enrolledVideos.length}}
        <div class="row g-2">

          {{#each enrolledVideos}}
            <div class="col-md-3 col-sm-6">
              <div class="card h-100 shadow-sm border-0">

                <!-- Thumbnail -->
                <div class="position-relative">
                  <img src="https://img.youtube.com/vi/{{youtubeId}}/hqdefault.jpg"
                      class="card-img-top"
                      alt="{{title}}">

                  {{!-- Progress bar nếu đã xem --}}
                  {{#if (gt currentTime 0)}}
                    <div class="progress" style="height: 4px; position:absolute; bottom:0; left:0; right:0;">
                      <div class="progress-bar bg-orange"
                          role="progressbar"
                          style="width: {{calcPercent currentTime duration}}%;">
                      </div>
                    </div>
                  {{/if}}
                </div>

                <!-- Nội dung -->
                <div class="card-body d-flex flex-column p-2">
                  <h6 class="card-title small mb-1 text-truncate">{{title}}</h6>

                  {{!-- Nút logic --}}
                  {{#if (gt currentTime 5)}}
                    <a href="/video/start/{{_id}}" class="btn btn-sm btn-success mt-auto">
                      Tiếp tục xem
                    </a>
                  {{else}}
                    <a href="/video/showdetail/{{_id}}" class="btn btn-sm btn-outline-primary mt-auto">
                      Xem chi tiết
                    </a>
                  {{/if}}
                </div>

              </div>
            </div>
          {{/each}}

        </div>

      {{else}}

        <div class="text-center py-4">
          <div class="empty-state">
            <i class="fas fa-video fa-3x text-muted mb-3"></i>
            <h6 class="text-muted mb-2">Bạn chưa quan tâm video nào</h6>
            <p class="text-muted mb-3 small">Khám phá các video của chúng tôi</p>
            <a href="/video" class="btn btn-outline-orange btn-sm">
             Khám phá video
            </a>
          </div>
        </div>

      {{/if}}
    </div>
  </div>

  {{!-- Modal chúc mừng --}}
  {{#if showCongrats}}
  <div class="modal fade" id="congratsModal" tabindex="-1" aria-labelledby="congratsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-lg border-0 overflow-hidden">
        
        <!-- Header với nền gradient -->
        <div class="modal-header border-0 text-success">
          <h5 style="color: #198754" class="modal-title fw-bold d-flex align-items-center" id="congratsModalLabel">
            Chào {{user.username}}!
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        
        <!-- Nội dung -->
        <div class="modal-body text-center p-4">
          <h4 class="fw-bold text-success mb-3">Đăng ký thành công!</h4>
          <p class="text-muted mb-4">Chào mừng bạn đến với <span class="fw-bold text-dark">Hệ thống hỗ trợ quản lý tiến độ học tập</span>.</p>
          <img src="/img/congrat.png" alt="Congrats" class="img-fluid mb-4" style="max-height:200px;">
        </div>
        
        {{!-- <!-- Footer với nút đóng -->
        <div class="modal-footer border-0 justify-content-center pb-4">
          <button type="button" class="btn btn-success px-4 rounded-pill shadow-sm" data-bs-dismiss="modal">
            <i class="fas fa-check-circle me-2"></i>Bắt đầu ngay
          </button>
        </div> --}}
      </div>
    </div>
  </div>
  {{/if}}

</main>

<style>
#creditChart {
  width: 92% !important;
  height: 92% !important;
  margin: 0;
  display: block;
}
</style>

{{!-- Modal congrats --}}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById('congratsModal');
    if (modalEl) {
      const modal = new bootstrap.Modal(modalEl, {
        backdrop: 'static',
        keyboard: false
      });

      let running = true;

      // Hàm bắn confetti liên tục
      function fireConfetti() {
        if (!running) return;
        confetti({
          particleCount: 5,
          startVelocity: 25,
          spread: 360,
          origin: { x: Math.random(), y: Math.random() - 0.2 }
        });
        requestAnimationFrame(fireConfetti);
      }

      // Khi modal hiển thị
      modal.show();
      fireConfetti();

      // Khi modal đóng => dừng confetti
      modalEl.addEventListener('hidden.bs.modal', () => {
        running = false;
      });
    }
  });
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const totalCredits = {{totalCredits}};
  const remainingCredits = {{maxCredits}} - totalCredits;
  const totalNoSubjects = {{totalNoSubjects}};

  const ctx = document.getElementById('creditChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Đã hoàn thành', 'Còn lại', 'Môn bị nợ'],
      datasets: [{
        label: 'Thống kê học tập',
        data: [totalCredits, remainingCredits, totalNoSubjects],
        backgroundColor: ['#ff8c42', '#cfd8dc', '#ef9a9a'],
        borderColor: ['#ff6f00', '#b0bec5', '#e57373'],
        borderWidth: 1,
        borderRadius: 8,
        barPercentage: 0.5,
        categoryPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // ✅ fit với card
      scales: {
        x: {
          ticks: { maxRotation: 30, minRotation: 0 }
        },
        y: {
          beginAtZero: true,
          max: {{maxCredits}},
          title: { display: true, text: 'Số tín chỉ' },
          ticks: { stepSize: 20 }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.parsed.y} tín chỉ`
          }
        }
      }
    }
  });
</script>