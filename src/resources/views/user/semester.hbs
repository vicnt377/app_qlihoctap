<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h2 fw-bold text-white mb-1">
          <i class="fas fa-calendar-alt me-2"></i>Lịch Học
        </h1>
        <p class="text-white-50 mb-0">Quản lý thời khóa biểu và lịch học các học kỳ</p>
      </div>
    </div>
  </div>
</div>

<main class="container mt-4">

<!-- Tabs -->
<ul class="nav nav-pills nav-fill" id="semesterTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="calendar-tab" data-bs-toggle="pill" data-bs-target="#calendarSection" type="button">
      <i class="fas fa-calendar-week me-2"></i><strong>Thời khóa biểu</strong>
    </button>
  </li>
  <li class="nav-item" role="presentation">
     <button class="nav-link" id="add-tab" data-bs-toggle="pill" data-bs-target="#addSection" type="button">
       <i class="fas fa-plus-circle me-2"></i><strong>Thêm học kỳ</strong>
     </button>
   </li>
   <li class="nav-item" role="presentation">
     <button class="nav-link" id="list-tab" data-bs-toggle="pill" data-bs-target="#listSection" type="button">
       <i class="fas fa-list me-2"></i><strong>Danh sách học kỳ</strong>
     </button>
   </li>
 </ul>

<!-- Nội dung tab -->
<div class="tab-content" id="semesterTabContent">
  <!-- Tab 1: Calendar -->
  <div class="tab-pane fade show active" id="calendarSection">
    <div class="mt-3">
      <div id="calendar"></div>
    </div>
  </div>

  <!-- Tab 2: Form thêm học kỳ + Danh sách học phần -->
  <div class="tab-pane fade" id="addSection">
    <div class="row g-3">
      <!-- Form thêm học kỳ -->
      <div class="col-md-8">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-success text-white py-2 small fw-bold">
            Thêm học kỳ
          </div>
          <div class="card-body d-flex flex-column">
            <form id="addSemesterForm" class="row g-3 flex-grow-1 align-items-end">
              <div class="col-md-4">
                <label for="tenHocKy" class="form-label small fw-bold">Tên học kỳ</label>
                <input type="text" class="form-control form-control-sm"
                      id="tenHocKy" name="tenHocKy" placeholder="VD: Học kỳ 1" required>
              </div>
              <div class="col-md-4">
                <label for="startDate" class="form-label small fw-bold">Ngày bắt đầu</label>
                <input type="date" class="form-control form-control-sm"
                      id="startDate" name="startDate" required>
              </div>
              <div class="col-md-2">
                <label for="soTuan" class="form-label small fw-bold">Số tuần</label>
                <input type="number" class="form-control form-control-sm"
                      id="soTuan" name="soTuan" min="1" max="52" value="18" required>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-success btn-sm w-100">
                  <i class="fas fa-check-circle"></i> Thêm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Form import học phần -->
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-primary text-white py-2 small fw-bold">
            Import học phần
          </div>
          <div class="card-body d-flex justify-content-center align-items-center">
            <form id="importForm" action="/course/import" method="POST"
                  enctype="multipart/form-data" class="d-flex gap-2">
              
              <!-- Choose file -->
              <input type="file" 
                    name="excelFile" 
                    id="excelFile"
                    accept=".xlsx,.xls" 
                    class="form-control form-control-sm" 
                    required>

              <!-- Import button -->
              <button type="submit" class="btn btn-primary btn-sm px-3 text-white fw-bold">
                <i class="bi bi-upload me-1"></i> Import
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Danh sách học phần -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-gradient-gray d-flex justify-content-between align-items-center">
        <span class="text-white fw-bold">Danh sách học phần</span>

        <div class="d-flex align-items-center">
          <input type="text" id="courseSearch" 
                class="form-control form-control-sm me-2" 
                placeholder="Tìm kiếm mã hoặc tên học phần...">
          <button class="btn btn-sm btn-orange align-items-end" 
                  data-bs-toggle="modal" data-bs-target="#addCourseModal">
            <i class="fas fa-plus me-1"></i>
          </button>
        </div>
      </div>

      <div class="card-body p-3">
        <div class="table-scroll-wrapper">
          <table class="table table-hover table-sm mb-0" id="courseTable">
            <thead>
              <tr>
                <th class="col-stt">STT</th>
                <th class="col-name">Tên học phần</th>
                <th class="col-code">Mã học phần</th>
                <th class="col-day">Thứ</th>
                <th class="col-time">Giờ bắt đầu</th>
                <th class="col-time">Giờ kết thúc</th>
                <th class="col-choose text-center">Chọn</th>
              </tr>
            </thead>
            <tbody>
              {{#if courses.length}}
                {{#each courses}}
                  <tr>
                    <td class="text-center col-stt">{{inc @index}}</td>
                    <td class="col-name">{{tenHocPhan}}</td>
                    <td class="col-code">{{maHocPhan}}</td>
                    <td class="col-day">
                      <select class="form-select form-select-sm" name="thu_{{_id}}">
                        {{#each (array "Thứ Hai" "Thứ Ba" "Thứ Tư" "Thứ Năm" "Thứ Sáu" "Thứ Bảy")}}
                          <option value="{{this}}">{{this}}</option>
                        {{/each}}
                      </select>
                    </td>
                    <td class="col-time"><input type="time" class="form-control form-control-sm" name="gioBatDau_{{_id}}"></td>
                    <td class="col-time"><input type="time" class="form-control form-control-sm" name="gioKetThuc_{{_id}}"></td>
                    <td class="text-center col-choose"><input type="checkbox" name="selectedCourses" value="{{_id}}"></td>
                  </tr>
                {{/each}}
              {{else}}
                <tr>
                  <td colspan="7" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i> Chưa có học phần nào được tạo.
                  </td>
                </tr>
              {{/if}}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Tab 3: Danh sách học kỳ -->
  <div class="tab-pane fade" id="listSection">
    {{#if classesGroupedBySemester.length}}
      {{#each classesGroupedBySemester}}
        <div class="card mb-4">
          <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
            <h4 style="color: #0dcaf0">{{tenHocKy}} ({{formatDate startDate}} → {{formatDate (addDays startDate (multiply soTuan 7))}})</h4>
            <div>
              <a href="/semester/edit/{{_id}}" class="btn btn-sm btn-warning">Sửa</a>
              <button onclick="deleteSemester('{{_id}}')" class="btn btn-sm btn-danger">Xóa</button>
            </div>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>STT</th>
                  <th>Tên học phần</th>
                  <th>Mã học phần</th>
                  <th>Thứ</th>
                  <th>Giờ bắt đầu</th>
                  <th>Giờ kết thúc</th>
                  <th>Tín chỉ</th>
                </tr>
              </thead>
              <tbody>
                {{#each scores}}
                  <tr>
                    <td>{{inc @index}}</td>
                    <td>{{HocPhan.tenHocPhan}}</td>
                    <td>{{HocPhan.maHocPhan}}</td>
                    <td>{{thu}}</td>
                    <td>{{gioBatDau}}</td>
                    <td>{{gioKetThuc}}</td>
                    <td>{{HocPhan.soTinChi}}</td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      {{/each}}
    {{else}}
      <div class="text-center mb-0" role="alert">
        <i class="fas fa-info-circle me-2"></i>
          Bạn chưa có học kỳ nào được tạo.
      </div>
    {{/if}}
  </div>
</div>


<!-- Modal Thêm Học Phần -->
<div class="modal fade" id="addCourseModal" tabindex="-1" aria-labelledby="addCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="/course/add-course" method="POST" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCourseModalLabel">Thêm học phần mới</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="maHocPhan" class="form-label">Mã học phần</label>
          <input type="text" class="form-control" id="maHocPhan" name="maHocPhan" required>
        </div>
        <div class="mb-3">
          <label for="tenHocPhan" class="form-label">Tên học phần</label>
          <input type="text" class="form-control" id="tenHocPhan" name="tenHocPhan" required>
        </div>
        <div class="mb-3">
          <label for="soTinChi" class="form-label">Số tín chỉ</label>
          <input type="number" class="form-control" id="soTinChi" name="soTinChi" min="1" required>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
        <button type="submit" class="btn btn-success btn-sm">Lưu</button>
      </div>
    </form>
  </div>
</div>
</main>

<script>
  document.getElementById("courseSearch").addEventListener("keyup", function () {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll("#courseTable tbody tr");

    rows.forEach(row => {
      const tenHocPhan = row.querySelector(".col-name")?.textContent.toLowerCase() || "";
      const maHocPhan = row.querySelector(".col-code")?.textContent.toLowerCase() || "";

      row.style.display = (tenHocPhan.includes(searchText) || maHocPhan.includes(searchText))
        ? ""
        : "none";
    });
  });
</script>


<script>
document.getElementById('addSemesterForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const tenHocKy = document.getElementById('tenHocKy').value.trim();
  const startDate = document.getElementById('startDate').value;
  const soTuan = document.getElementById('soTuan').value || 18;

  const checkboxes = document.querySelectorAll('input[name="selectedCourses"]:checked');
  const selectedCoursesData = Array.from(checkboxes).map(cb => {
    const courseId = cb.value;
    const thu = document.querySelector(`[name="thu_${courseId}"]`).value.trim();
    const gioBatDau = document.querySelector(`[name="gioBatDau_${courseId}"]`).value;
    const gioKetThuc = document.querySelector(`[name="gioKetThuc_${courseId}"]`).value;
    return { courseId, thu, gioBatDau, gioKetThuc };
  });

  if (!tenHocKy || !startDate || selectedCoursesData.length === 0) {
    alert('Vui lòng nhập đầy đủ thông tin và chọn ít nhất một học phần!');
    return;
  }

  try {
    const response = await fetch('/semester/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        tenHocKy,
        startDate,
        soTuan,
        selectedCourses: selectedCoursesData
      }),
    });

    const data = await response.json();

    if (response.ok) {
      alert(data.message || '✅ Thêm học kỳ thành công!');
      location.reload();
    } else {
      alert(data.message || '❌ Đã xảy ra lỗi khi thêm học kỳ.');
    }

  } catch (error) {
    console.error('Lỗi fetch:', error);
    alert('❌ Lỗi kết nối đến server.');
  }
});
</script>

<script>
  function deleteSemester(id) {
    if (confirm("Bạn có chắc chắn muốn xóa học kỳ này?")) {
      fetch(`/semester/delete/${id}`, {
        method: 'POST'
      })
        .then(res => res.ok ? location.reload() : alert("Không thể xóa học kỳ."))
        .catch(err => {
          console.error(err);
          alert("Lỗi server.");
        });
    }
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'vi',
      initialView: 'timeGridWeek',
      allDaySlot: false,
      slotMinTime: '07:00:00',
      slotMaxTime: '18:00:00',
      headerToolbar: {
        left: 'prev,today,next',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      height: 'auto',
      expandRows: true,
      events: {{{json events}}},
      eventDidMount: function(info) {
        new bootstrap.Tooltip(info.el, {
          title: info.event.title,
          placement: 'top'
        });
      }
    });

    calendar.render();
  });
</script>

