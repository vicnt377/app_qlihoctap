<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h2 fw-bold  mb-2">
        H·ªèi ƒê√°p
        </h1>
        <p class=" mb-0">Li√™n h·ªá v√† nh·∫≠n h·ªó tr·ª£ t·ª´ ƒë·ªôi ng≈© qu·∫£n tr·ªã</p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid px-5">
  <div class="card shadow-sm border-0">
    {{!-- <div class="card-header bg-gradient-gray text-white py-3">
      <h6 class="mb-0"><i class="fas fa-comments me-2"></i>H·ªôp th∆∞ h·ªó tr·ª£</h6>
    </div> --}}

    <div class="card-body p-0">
      <!-- Messages Area -->
      <div class="messages p-4" id="messages" 
           style="height: 400px; overflow-y: auto; background: #f8f9fa;">

        <!-- ‚úÖ Tin nh·∫Øn c≈© -->
        {{#each messages}}
          {{#if (eq (toString sender._id) (toString ../user._id))}}
            <div class="text-end mb-3">
              <div class="bg-orange text-white d-inline-block p-3 rounded-3 shadow-sm">
                <div class="mb-1">{{content}}</div>
                <small class="text-white-50">{{sender.name}} (B·∫°n)</small>
              </div>
            </div>
          {{else}}
            <div class="text-start mb-3">
              <div class="bg-secondary text-white d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 70%;">
                <div class="mb-1">{{content}}</div>
                <small class="text-white-50">{{sender.name}} (Admin)</small>
              </div>
            </div>
          {{/if}}
        {{/each}}
        <!-- ‚úÖ Tin nh·∫Øn ch√†o t·ª´ Admin -->
        <div class="text-start mb-3">
          <div class="bg-light d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 80%;">
            <div class="mb-2">
              Xin ch√†o, t√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
            </div>
            <small class="text-muted">(Admin)</small>
          </div>
        </div>

        <!-- ‚úÖ Danh s√°ch g·ª£i √Ω hi·ªÉn th·ªã trong chat -->
        <div class="text-start mb-3">
          <div class="bg-white border d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 80%;">
            <p class="fw-bold mb-2">B·∫°n mu·ªën h·ªèi v·ªÅ:</p>
            <div class="list-group list-group-flush">
              {{#each suggestions}}
                <button class="list-group-item list-group-item-action suggestion-btn text-primary border-0 px-0 py-1 text-start"
                        data-keyword="{{this.keyword}}">
                  {{this.text}}
                </button>
              {{/each}}
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input Form -->
      <div class="p-3 border-top bg-white">
        <form id="chatForm" class="chat-form">
          <div class="input-group">
            <input type="text" id="messageInput" class="form-control" 
                   placeholder="Nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n t·∫°i ƒë√¢y..." required>
            <button type="submit" class="btn btn-orange">
              {{!-- <i class="fas fa-paper-plane me-1"></i> --}}G·ª≠i
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

{{!-- <script>

  const userId = '{{user._id}}';
  const adminId = '{{adminId}}';

  // ‚úÖ G·ª≠i userId cho server khi k·∫øt n·ªëi
  socket.emit('register', { userId });

  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('messageInput');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    // ‚úÖ G·ª≠i message qua socket
    socket.emit('chatMessage', {
      senderId: userId,
      receiverId: adminId,
      message
    });

    // ‚úÖ Hi·ªÉn th·ªã ngay tr√™n giao di·ªán
    addMessage(message, 'user-message');
    input.value = '';

    // ‚úÖ L∆∞u v√†o DB qua fetch
    const res = await fetch('/chat/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const data = await res.json();

    if (data.autoReply) {
      addMessage(data.autoReply, 'admin-message');
    } else if (data.reply) {
      addMessage(data.reply, 'admin-message');
    }
  });

  socket.on('newMessage', ({ senderId, message }) => {
    console.log("üì® Nh·∫≠n t·ª´ admin:", senderId, message);
    addMessage(message, 'admin-message');
  });

  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerText = content;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ‚úÖ X·ª≠ l√Ω g·ª£i √Ω
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("chatForm");
    const input = document.getElementById("messageInput");

    document.querySelectorAll(".suggestion-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const keyword = btn.dataset.keyword;
        input.value = keyword;
        form.dispatchEvent(new Event("submit")); // gi·∫£ l·∫≠p submit
      });
    });
  });

</script> --}}
<script src="/socket.io/socket.io.js"></script>
<script>

  // ‚≠ê Socket ri√™ng cho User Chat
  const userSocket = io();

  const userId = '{{user._id}}';
  const adminId = '{{adminId}}';

  // ‚≠ê G·ª≠i userId cho server ƒë·ªÉ ƒëƒÉng k√Ω socket
  userSocket.emit('register', { userId });

  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('messageInput');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    // ‚≠ê G·ª≠i tin nh·∫Øn qua chat socket ri√™ng
    userSocket.emit('chatMessage', {
      senderId: userId,
      receiverId: adminId,
      message
    });

    // ‚≠ê Hi·ªÉn th·ªã ngay tin nh·∫Øn c·ªßa user
    addMessage(message, 'user-message');
    input.value = '';

    // ‚≠ê L∆∞u tin nh·∫Øn v√†o MongoDB qua API
    const res = await fetch('/chat/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const data = await res.json();

    if (data.autoReply) {
      addMessage(data.autoReply, 'admin-message');
    } else if (data.reply) {
      addMessage(data.reply, 'admin-message');
    }
  });

  // ‚≠ê Nh·∫≠n tin nh·∫Øn realtime t·ª´ Admin
  userSocket.on('newMessage', ({ senderId, message }) => {
    console.log("üì® Nh·∫≠n t·ª´ admin:", senderId, message);
    addMessage(message, 'admin-message');
  });

  // ‚≠ê H√†m th√™m tin nh·∫Øn v√†o giao di·ªán
  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerText = content;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // ‚≠ê Click v√†o g·ª£i √Ω ‚Üí g·ª≠i lu√¥n
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".suggestion-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const keyword = btn.dataset.keyword;
        input.value = keyword;
        form.dispatchEvent(new Event("submit"));
      });
    });
  });

</script>
