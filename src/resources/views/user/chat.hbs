<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h2 fw-bold  mb-2">
        Hỏi Đáp
        </h1>
        <p class=" mb-0">Liên hệ và nhận hỗ trợ từ đội ngũ quản trị</p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid px-5">
  <div class="card shadow-sm border-0">
    {{!-- <div class="card-header bg-gradient-gray text-white py-3">
      <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Hộp thư hỗ trợ</h6>
    </div> --}}

    <div class="card-body p-0">
      <!-- Messages Area -->
      <div class="messages p-4" id="messages" 
           style="height: 400px; overflow-y: auto; background: #f8f9fa;">

        <!-- ✅ Tin nhắn cũ -->
        {{#each messages}}
          {{#if (eq (toString sender._id) (toString ../user._id))}}
            <div class="text-end mb-3">
              <div class="bg-orange text-white d-inline-block p-3 rounded-3 shadow-sm">
                <div class="mb-1">{{content}}</div>
                <small class="text-white-50">{{sender.name}} (Bạn)</small>
              </div>
            </div>
          {{else}}
            <div class="text-start mb-3">
              <div class="bg-secondary text-white d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 70%;">
                <div class="mb-1">{{content}}</div>
                <small class="text-white-50">{{sender.name}} (Admin)</small>
              </div>
            </div>
          {{/if}}
        {{/each}}
        <!-- ✅ Tin nhắn chào từ Admin -->
        <div class="text-start mb-3">
          <div class="bg-light d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 80%;">
            <div class="mb-2">
              Xin chào, tôi có thể giúp gì cho bạn?
            </div>
            <small class="text-muted">(Admin)</small>
          </div>
        </div>

        <!-- ✅ Danh sách gợi ý hiển thị trong chat -->
        <div class="text-start mb-3">
          <div class="bg-white border d-inline-block p-3 rounded-3 shadow-sm" style="max-width: 80%;">
            <p class="fw-bold mb-2">Bạn muốn hỏi về:</p>
            <div class="list-group list-group-flush">
              {{#each suggestions}}
                <button class="list-group-item list-group-item-action suggestion-btn text-primary border-0 px-0 py-1 text-start"
                        data-keyword="{{this.keyword}}">
                  {{this.text}}
                </button>
              {{/each}}
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input Form -->
      <div class="p-3 border-top bg-white">
        <form id="chatForm" class="chat-form">
          <div class="input-group">
            <input type="text" id="messageInput" class="form-control" 
                   placeholder="Nhập yêu cầu của bạn tại đây..." required>
            <button type="submit" class="btn btn-orange">
              {{!-- <i class="fas fa-paper-plane me-1"></i> --}}Gửi
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>


<script src="/socket.io/socket.io.js"></script>
<script>
  // SOCKET USER
  const userSocket = io();

  const userId = '{{user._id}}';
  const adminId = '{{adminId}}';

  userSocket.emit('register', { userId });

  const messagesEl = document.getElementById('messages');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('messageInput');

  // GỬI TIN NHẮN
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const message = input.value.trim();
    if (!message) return;

    userSocket.emit('chatMessage', {
      senderId: userId,
      receiverId: adminId,
      message
    });

    // Hiển thị ngay tin user
    addMessage(message, 'user-message');

    input.value = '';
  });

  // NHẬN TIN NHẮN REALTIME (ADMIN + AUTO-REPLY)
  userSocket.on('newMessage', ({ senderId, message }) => {
    if (senderId === adminId) {
      addMessage(message, 'admin-message');
    }
  });

  function addMessage(content, type) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerText = content;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // CLICK GỢI Ý
  document.querySelectorAll('.suggestion-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      input.value = btn.dataset.keyword;
      form.dispatchEvent(new Event('submit'));
    });
  });
</script>


