<div class="dashboard-header mb-3">
  <h2 class="dashboard-title"> Bắt Đầu Học: {{video.title}}</h2>
</div>

<div class="container">
  <div class="row">
    <!-- Video học -->
    <div class="col-md-8">
      <div class="ratio ratio-16x9 rounded shadow-sm mb-3">
        {{!-- <iframe
          src="https://www.youtube.com/embed/{{video.youtubeId}}?autoplay=1&rel=0"
          title="{{video.title}}"
          frameborder="0"
          allow="autoplay; encrypted-media"
          allowfullscreen
        ></iframe> --}}
        <div id="player"></div>
      </div>


    </div>

    <!-- Thông tin khóa học -->
    <div class="col-md-4">
      <div class="card p-3 mb-3 shadow-sm">
        <h5 class="card-title mb-2">Thông tin</h5>
        <ul class="list-unstyled small">
          <li><strong>Thời lượng:</strong> {{duration}}</li>
          <li><strong>Danh mục:</strong> {{video.category}}</li>
        </ul>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="card-title mb-2">Mô tả</h5>
        <p class="card-text">{{video.description}}</p>
      </div>

      <a href="/video" class="btn btn-primary w-100"><i class="fas fa-arrow-left me-1"></i> Quay lại danh sách</a>
    </div>
  </div>
</div>

<script>
  let player;
  const savedTime = Number("{{video.currentTime}}") || 0;
  const videoDbId = "{{video._id}}";
  let hasSeeked = false;

  // Load YT API
  const tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);

  // Create player
  function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
      videoId: "{{video.youtubeId}}",
      playerVars: {
        autoplay: 1,
        rel: 0,
        controls: 1
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange
      }
    });
  }

  function onPlayerReady(event) {
    event.target.playVideo();

    // Phòng trường hợp seek quá sớm
    setTimeout(() => {
      if (savedTime > 1 && !hasSeeked) {
        player.seekTo(savedTime, true);
        hasSeeked = true;
      }
    }, 800);
  }

  // Khi trạng thái video thay đổi
  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.PLAYING && !hasSeeked) {
      if (savedTime > 1) {
        player.seekTo(savedTime, true);
      }
      hasSeeked = true;
    }
  }

  // SAVE PROGRESS mỗi 5s
  setInterval(() => {
    if (!player || typeof player.getCurrentTime !== "function") return;

    const current = player.getCurrentTime();
    const duration = player.getDuration();

    fetch(`/video/save-progress/${videoDbId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ currentTime: current, duration })
    });
  }, 5000);
</script>




