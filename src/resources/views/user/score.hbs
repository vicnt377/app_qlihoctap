<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h2 fw-bold text-white mb-1">
          <i class="fas fa-graduation-cap me-2"></i>Kết Quả Học Tập
        </h1>
        <p class="text-white-50 mb-0">Xem và cập nhật điểm số các học phần</p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid px-4">
  <!-- Filter Form -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-gradient-gray text-white py-3">
      <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Bộ lọc kết quả</h6>
    </div>
    <div class="card-body p-4">
      <form method="GET" action="/score" class="row g-3">
        <div class="col-md-4">
          <label for="year" class="form-label fw-bold">
            <i class="fas fa-calendar me-2 text-orange"></i>Năm học
          </label>
          <select name="year" class="form-select">
            <option value="Tất cả" {{#if (eq selectedYear 'Tất cả')}}selected{{/if}}>Tất cả</option>
            {{#each years}}
              <option value="{{this}}" {{#if (eq ../selectedYear this)}}selected{{/if}}>{{this}}</option>
            {{/each}}
          </select>
        </div>
        <div class="col-md-4">
          <label for="semester" class="form-label fw-bold">
            <i class="fas fa-graduation-cap me-2 text-orange"></i>Học kỳ
          </label>
          <select name="semester" class="form-select">
            <option value="Tất cả" {{#if (eq selectedSemester 'Tất cả')}}selected{{/if}}>Tất cả</option>
            {{#each semestersList}}
              <option value="{{this}}" {{#if (eq ../selectedSemester this)}}selected{{/if}}>{{this}}</option>
            {{/each}}
          </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-orange w-100">
            <i class="fas fa-search me-1"></i>Lọc kết quả
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-4">
    <!-- Tổng kết toàn khóa -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-gradient-gray text-white py-3">
          <h6 class="mb-0">
            <i class="fas fa-trophy me-2"></i>Tổng kết toàn khóa
          </h6>
        </div>
        <div class="card-body p-3">

          {{!-- Nếu có tín chỉ thì hiển thị kết quả --}}
          {{#ifCond tongTinChi '>' 0}}
            <div class="text-center mb-3">
              <i class="fas fa-medal fa-2x text-orange mb-2"></i>
              <h6 class="fw-bold">Kết quả học tập</h6>
            </div>
            
            <div class="mb-2">
              <label class="form-label fw-bold text-muted small">Trung Bình Tích Lũy</label>
              <div class="h4 fw-bold text-orange">{{gpa}}</div>
            </div>
            
            <div class="mb-2">
              <label class="form-label fw-bold text-muted small">Xếp loại học lực</label>
              <div class="badge bg-warning text-dark fs-6 px-2 py-1">{{hocLuc}}</div>
            </div>
            
            {{#if canhBaoHocVu}}
              <div class="alert alert-danger mt-2 mb-0 py-2" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>{{canhBaoHocVu}}</strong>
              </div>
            {{/if}}
          {{else}}
            <div class="text-center py-4 text-muted">
              <i class="fas fa-info-circle fa-2x mb-2"></i>
              <p class="mb-0">Bạn chưa có học kỳ nào để tính điểm</p>
            </div>
          {{/ifCond}}
        </div>
      </div>
    </div>

    <!-- Bảng điểm -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-3">
          <h6 class="mb-0"><i class="fas fa-table me-2"></i>Chi tiết điểm số</h6>
        </div>
        <div class="card-body p-4">
          {{#if semesters.length}}
            <form method="POST" action="/score/update">
              {{#each semesters}}
                <div class="mb-3">
                  <h6 class="text-info border-bottom pb-1 mb-2">
                    <i class="fas fa-calendar-alt me-2"></i>{{tenHocKy}} - {{namHoc}}
                  </h6>
                  <div class="table-responsive">
                    <table class="table table-hover table-sm">
                      <thead class="table-light">
                        <tr>
                          <th class="py-2">Mã HP</th>
                          <th class="py-2">Tên Học Phần</th>
                          <th class="text-center py-2">Tín chỉ</th>
                          <th class="text-center py-2">Điểm Số</th>
                          <th class="text-center py-2">Điểm Chữ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {{#each score}}
                        <tr>
                          <td class="py-1"><code>{{HocPhan.maHocPhan}}</code></td>
                          <td class="py-1">{{HocPhan.tenHocPhan}}</td>
                          <td class="text-center py-1">{{HocPhan.soTinChi}}</td>
                          <td class="text-center py-1">
                            <input 
                              type="number" 
                              step="0.1" 
                              min="0" 
                              max="10"
                              name="scores[{{_id}}][diemSo]" 
                              class="form-control form-control-sm text-center py-1"
                              value="{{diemSo}}">
                          </td>
                          <td class="text-center py-1">
                            <input 
                              type="text" 
                              name="scores[{{_id}}][diemChu]" 
                              class="form-control form-control-sm text-center py-1" 
                              value="{{diemChu}}">
                          </td>
                        </tr>
                        {{/each}}
                      </tbody>

                    </table>
                  </div>
                </div>
              {{/each}}

              <div class="text-center mt-4">
                <button type="submit" class="btn btn-orange btn-lg px-5">
                  <i class="fas fa-save me-2"></i>Lưu điểm
                </button>
              </div>
            </form>
          {{else}}
            <div class="alert alert-info text-center mb-0" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              Bạn chưa có học kỳ nào để tính điểm.
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  function convertDiemSoToDiemChu(diemSo) {
    const score = parseFloat(diemSo);
    if (isNaN(score)) return '';
    if (score >= 9.0) return 'A';
    if (score >= 8.0) return 'B+';
    if (score >= 7.0) return 'B';
    if (score >= 6.0) return 'C+';
    if (score >= 5.0) return 'C';
    if (score >= 4.0) return 'D';
    return 'F';
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('input[name^="scores"][name$="[diemSo]"]').forEach(input => {
      input.addEventListener('input', (e) => {
        const scoreInput = e.target;
        const diemChuInput = scoreInput.closest('tr').querySelector('input[name$="[diemChu]"]');
        diemChuInput.value = convertDiemSoToDiemChu(scoreInput.value);
      });
    });
  });
</script>

