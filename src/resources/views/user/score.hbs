<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
         <h1 class="h2 fw-bold mb-2">
           Kết Quả Học Tập
         </h1>
          <p class=" mb-0">Xem và cập nhật điểm số các học phần</p>
      </div>
      {{!-- <div class="col-md-4">
        <div class="row g-2">
          <div class="col-6">
            <div class="stats-card p-2 text-center">
              <div class="stats-item">
                <i class="fas fa-trophy text-orange mb-1"></i>
                <div class="stats-number small">
                  {{gpa}}
                </div>
                <div class="stats-label small">GPA</div>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="stats-card p-2 text-center">
              <div class="stats-item">
                <i class="fas fa-graduation-cap text-orange mb-1"></i>
                <div class="stats-number small">{{hocLuc}}</div>
                <div class="stats-label small">Xếp loại</div>
              </div>
            </div>
          </div>
        </div>
      </div> --}}
    </div>
  </div>
</div>


<main class="container-fluid px-4">
  <div class="row g-4">
  <!-- Cột trái: Bộ lọc + Tổng kết toàn khóa -->
    <div class="col-lg-4">
      <!-- Bộ lọc -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-gradient-gray text-white py-3">
          <h6 class="mb-0">Bộ lọc kết quả</h6>
        </div>
        <div class="card-body p-4">
          <form method="GET" action="/score" class="row g-3">
            <div class="col-md-12">
              <label for="year" class="form-label fw-bold">
                Năm học
              </label>
              <select name="year" class="form-select">
                <option value="Tất cả" {{#if (eq selectedYear 'Tất cả')}}selected{{/if}}>Tất cả</option>
                {{#each years}}
                  <option value="{{this}}" {{#if (eq ../selectedYear this)}}selected{{/if}}>{{this}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-12">
              <label for="semester" class="form-label fw-bold">
                Học kỳ
              </label>
              <select name="semester" class="form-select">
                <option value="Tất cả" {{#if (eq selectedSemester 'Tất cả')}}selected{{/if}}>Tất cả</option>
                {{#each semestersList}}
                  <option value="{{this}}" {{#if (eq ../selectedSemester this)}}selected{{/if}}>{{this}}</option>
                {{/each}}
              </select>
            </div>
            <div class="col-md-12 align-items-center">
              <button type="submit" class="btn btn-orange">
                <i class="fas fa-search me-1"></i>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Tổng kết toàn khóa -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-3">
          <h6 class="mb-0">Tổng kết</h6>
        </div>

        <div class="card-body p-3">

          {{#ifCond tongTinChiTongKet '>' 0}}

            <div class="mb-2">
              <label class="form-label fw-bold text-muted small">Trung Bình Tích Lũy</label>
              <div class="h4 fw-bold text-orange">{{gpaTongKet}}</div>
            </div>

            <div class="mb-2">
              <label class="form-label fw-bold text-muted small">Xếp loại học lực</label>
              <div class="badge bg-warning text-dark fs-6 px-2 py-1">{{hocLucTongKet}}</div>
            </div>

            {{#if canhBaoHocVuTongKet}}
              <div class="alert alert-danger mt-2 mb-0 py-2">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>{{canhBaoHocVuTongKet}}</strong>
              </div>
            {{/if}}

          {{else}}

            {{#if hasSemester}}
              <div class="text-center py-4 text-muted">
                <i class="fas fa-pen-alt fa-2x mb-2"></i>
                <p class="mb-0">Bạn đã có học kỳ nhưng chưa nhập điểm.</p>
              </div>
            {{else}}
              <div class="text-center py-4 text-muted">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p class="mb-0">Bạn chưa có học kỳ nào để tính điểm</p>
              </div>
            {{/if}}

          {{/ifCond}}

        </div>
      </div>

    </div>

    <!-- Chi tiết điểm số -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-3">
          <h6 class="mb-0">
            Chi tiết điểm số
          </h6>
        </div>
        <div class="card-body p-4">
          {{#if semesters.length}}
            <form method="POST" action="/score/update">
              {{#each semesters}}
                <div class="mb-4">
                  <!-- Tiêu đề học kỳ -->
                  <h6 class="text-info border-bottom pb-2 mb-3">
                    {{tenHocKy}} ({{namHoc}})
                  </h6>

                  <!-- Bảng điểm -->
                  <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle">
                      <thead class="table-light">
                        <tr>
                          <th class="py-2">Mã HP</th>
                          <th class="py-2">Tên Học Phần</th>
                          <th class="text-center py-2">Tín chỉ</th>
                          <th class="text-center py-2">Điểm Số</th>
                          <th class="text-center py-2">Điểm Chữ</th>
                          <th class="text-center py-2">TBCHK</th>
                          <th class="text-center py-2">Tích lũy</th>
                        </tr>
                      </thead>
                      <tbody>
                        {{#each score}}
                          <tr>
                            <td><code>{{HocPhan.maHocPhan}}</code></td>
                            <td>{{HocPhan.tenHocPhan}}</td>
                            <td class="text-center">{{HocPhan.soTinChi}}</td>
                            <td class="text-center">
                              <input 
                                type="number" step="0.1" min="0" max="10"
                                name="scores[{{_id}}][diemSo]" 
                                class="form-control form-control-sm text-center"
                                value="{{diemSo}}">
                            </td>
                            <td class="text-center">
                              <input 
                                type="text" 
                                name="scores[{{_id}}][diemChu]" 
                                class="form-control form-control-sm text-center" 
                                value="{{diemChu}}">
                            </td>
                            <td class="text-center">
                              <input 
                                type="checkbox" 
                                class="form-check-input"
                                name="scores[{{_id}}][tbchk]"
                                {{#if tbchk}}checked{{/if}}
                              >
                            </td>
                            <td class="text-center">
                              <input 
                                type="checkbox" 
                                class="form-check-input"
                                name="scores[{{_id}}][tichLuy]"
                                {{#if tichLuy}}checked{{/if}}
                              >
                            </td>
                          </tr>
                        {{/each}}
                      </tbody>
                    </table>
                  </div>

                  <!-- Tổng kết học kỳ -->
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center border-top pt-2">
                      <strong class="text-muted">Trung bình học kỳ:</strong>
                      {{#if cpaHK}}
                        <span class="text-orange fw-bold">{{cpaHK}}</span>
                      {{else}}
                        <span class="text-muted">Chưa có điểm</span>
                      {{/if}}
                    </div>
                    <div class="d-flex justify-content-between align-items-center pt-2">
                      <strong class="text-muted">Tổng tích lũy:</strong>
                      <span class="text-orange fw-bold">{{tongTinChiTichLuyDenHK}}</span>
                    </div>
                  </div>
                </div>
              {{/each}}

              <!-- Nút lưu -->
              <div class="text-center mt-4">
                <button type="submit" class="btn btn-orange px-5">
                 Lưu điểm
                </button>
              </div>
            </form>

            <!-- Pagination -->
            {{#if pagination.totalPages}}
            <nav aria-label="Page navigation" class="mt-4">
              <ul class="pagination justify-content-center">
                {{#if pagination.hasPrevPage}}
                  <li class="page-item">
                    <a class="page-link" href="?page={{pagination.prevPage}}{{#if queryString.year}}&year={{queryString.year}}{{/if}}{{#if queryString.semester}}&semester={{queryString.semester}}{{/if}}">&laquo;</a>
                  </li>
                {{/if}}

                {{#each pagination.pages}}
                  <li class="page-item {{#ifEquals this ../pagination.currentPage}}active{{/ifEquals}}">
                    <a class="page-link" href="?page={{this}}{{#if ../queryString.year}}&year={{../queryString.year}}{{/if}}{{#if ../queryString.semester}}&semester={{../queryString.semester}}{{/if}}">{{this}}</a>
                  </li>
                {{/each}}

                {{#if pagination.hasNextPage}}
                  <li class="page-item">
                    <a class="page-link" href="?page={{pagination.nextPage}}{{#if queryString.year}}&year={{queryString.year}}{{/if}}{{#if queryString.semester}}&semester={{queryString.semester}}{{/if}}">&raquo;</a>
                  </li>
                {{/if}}
              </ul>
            </nav>
            {{/if}}

          {{else}}
            <div class="text-center text-muted py-4">
              <i class="fas fa-info-circle me-2"></i>
              Bạn chưa có học kỳ nào để tính điểm.
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  function convertDiemSoToDiemChu(diemSo) {
    const score = parseFloat(diemSo);
    if (isNaN(score)) return '';
    if (score >= 9.0) return 'A';
    if (score >= 8.0) return 'B+';
    if (score >= 7.0) return 'B';
    if (score >= 6.0) return 'C+';
    if (score >= 5.0) return 'C';
    if (score >= 4.0) return 'D';
    return 'F';
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('input[name^="scores"][name$="[diemSo]"]').forEach(input => {
      input.addEventListener('input', (e) => {
        const scoreInput = e.target;
        const diemChuInput = scoreInput.closest('tr').querySelector('input[name$="[diemChu]"]');
        diemChuInput.value = convertDiemSoToDiemChu(scoreInput.value);
      });
    });
  });
</script>

