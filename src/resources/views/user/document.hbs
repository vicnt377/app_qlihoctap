<!-- Header Section with Gradient Background -->
<div class="document-header mb-3">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h3 fw-bold mb-2">
          {{!-- <i class="fas fa-file-alt me-2"></i> --}}Tài Liệu
        </h1>
        <p class=" mb-0">Quản lý và chia sẻ tài liệu học tập của bạn</p>
      </div>
    </div>
  </div>
</div>

<main class="container-fluid px-4">
  <!-- Alert Messages -->
  {{#if successMessage}}
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
      <i class="fas fa-check-circle me-2"></i>{{successMessage}}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {{/if}}
  {{#if errorMessage}}
    <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>{{errorMessage}}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {{/if}}

  <!-- Simple Tabs Design - No Container -->
  <ul class="nav nav-pills mb-3" id="docTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="list-tab" data-bs-toggle="pill" data-bs-target="#list" type="button" role="tab">
        Tài liệu của tôi
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="reference-tab" data-bs-toggle="pill" data-bs-target="#reference" type="button" role="tab">
        Tài liệu tham khảo
      </button>
    </li>
  </ul>

  <div class="tab-content" id="docTabsContent">
    <!-- Tài liệu của tôi -->
    <div class="tab-pane fade show active" id="list" role="tabpanel">
      <div class="row g-3">
        <!-- Compact Upload Section -->
        <div class="col-lg-4">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-gradient-orange text-white py-2">
              <h6 class="mb-0">
                Tải lên tài liệu mới
              </h6>
            </div>
            <div class="card-body p-3">
              <form action="/document/upload" method="POST" enctype="multipart/form-data" id="uploadForm">
                <div class="mb-3">
                  <label for="title" class="form-label fw-bold small">
                    Tên tài liệu
                  </label>
                  <input type="text" id="title" name="title" class="form-control form-control-sm" required>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="public" id="visibility" name="visibility">
                  <label class="form-check-label" for="visibility">
                    Công khai 
                  </label>
                </div>
                <div class="mb-3">
                  <label for="file" class="form-label fw-bold small">
                    Chọn tệp
                  </label>
                  <!-- Upload area: giữ nguyên cấu trúc, nhưng input phủ toàn vùng (opacity:0) -->
                  <div class="file-upload-area" id="fileUploadArea" tabindex="0">
                    <input type="file" id="file" name="file" class="file-input" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx,.xls,.xlsx">
                    
                    <!-- placeholder sẽ ẩn khi đã chọn file -->
                    <div class="upload-placeholder text-center py-4" id="uploadPlaceholder">
                      <div class="upload-icon mb-3">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                      </div>
                      <h6 class="text-muted mb-2">Kéo thả file vào đây</h6>
                      <p class="text-muted mb-2 small">hoặc</p>
                      <button type="button" class="btn btn-outline-orange btn-sm" id="browseBtn">
                        Chọn file
                      </button>
                      <div class="mt-3">
                        <small class="text-muted">
                          Hỗ trợ: PDF, DOC, DOCX, TXT, PPT, PPTX, XLS, XLSX (Tối đa 10MB)
                        </small>
                      </div>
                    </div>

                    <!-- preview area (ẩn mặc định) -->
                    <div class="file-preview d-none" id="filePreview"></div>
                  </div>
                </div>
                <button type="submit" class="btn btn-orange w-100">
                  Tải lên tài liệu
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Compact Documents List -->
        <div class="col-lg-8">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-gradient-gray text-white py-2 d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                Danh sách tài liệu của tôi
              </h6>
              <!-- Ô tìm kiếm nhỏ gọn -->
              <form method="GET" action="/document" class="d-flex align-items-center">
                <input type="text" name="q" class="form-control form-control-sm me-2" 
                      placeholder="Tìm tài liệu..." value="{{query}}" style="width: 200px;">
                <button type="submit" class="btn btn-sm btn-light text-dark">
                  <i class="fas fa-search"></i>
                </button>
              </form>
            </div>
            <div class="card-body p-0">
              {{#if documents}}
                <div class="table-responsive">
                  <table class="table table-hover mb-0 table-sm">
                    <tbody>
                      {{#each documents}}
                        <tr class="document-row">
                          <td class="ps-3">
                            <div class="d-flex align-items-center">
                              <div class="document-icon me-2">
                                <i class="{{getFileIcon this}}"></i>
                              </div>
                              <div>
                                <h6 class="mb-0 fw-bold small">{{this.title}}</h6>
                                <small class="text-muted">{{this.originalName}}</small>
                              </div>
                            </div>
                          </td>
                          <td>
                            <span class="badge bg-light text-dark small">
                              <i class="fas fa-clock me-1"></i>{{formatDate this.createdAt}}
                            </span>
                          </td>
                          {{!-- <td>
                            <span class="badge bg-orange small">{{this.fileSize}}</span>
                          </td> --}}
                          <td class="text-center">
                            <div class="btn-group" role="group">
                              <button type="button" 
                                class="btn btn-sm btn-outline-orange" 
                                onclick="previewDocument('{{this._id}}', '{{this.title}}')">
                                <i class="fas fa-eye"></i>
                              </button>

                              <a href="/document/download/{{this._id}}" class="btn btn-sm btn-outline-orange" title="Tải xuống">
                                <i class="fas fa-download"></i>
                              </a>
                              <form action="/document/delete/{{this._id}}" method="POST" class="d-inline" 
                                    onsubmit="return confirm('Bạn có chắc muốn xóa tài liệu này?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </form>
                            </div>
                          </td>
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
              {{else}}
                <div class="text-center py-4">
                  <div class="empty-state">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted mb-2">Chưa có tài liệu nào</h6>
                    <p class="text-muted mb-3 small">Bắt đầu bằng cách tải lên tài liệu đầu tiên của bạn</p>
                  </div>
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tài liệu tham khảo -->
    <div class="tab-pane fade" id="reference" role="tabpanel">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-gray text-white py-2">
          <h6 class="mb-0">
            Danh sách tài liệu tham khảo
          </h6>
        </div>

        <div class="card-body p-0">
          {{#if referenceDocs}}
            <div class="table-responsive">
              <table class="table table-hover mb-0 table-sm">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Tên tài liệu</th>
                    <th scope="col">Người chia sẻ</th>
                    <th scope="col">Ngày đăng</th>
                    <th scope="col" class="text-center">Thao tác</th>
                  </tr>
                </thead>

                <tbody>
                  {{#each referenceDocs}}
                    <tr>
                      <!-- Tên tài liệu + cờ MỚI -->
                      <td>
                        <div class="d-flex align-items-center">
                          <div class="document-icon me-2">
                            <i class="{{getFileIcon this}}"></i>
                          </div>
                          <div>
                            <h6 class="mb-0 fw-bold small d-flex align-items-center">
                              {{this.title}}

                              {{#if this.isNew}}
                                <span class="badge bg-danger ms-2">Mới</span>
                              {{/if}}
                            </h6>
                            <small class="text-muted">{{this.originalName}}</small>
                          </div>
                        </div>
                      </td>

                      <!-- Người chia sẻ -->
                      <td>{{this.user.username}}</td>

                      <!-- Ngày đăng -->
                      <td>
                        <span class="badge bg-light text-dark small">
                          <i class="fas fa-clock me-1"></i>
                          {{formatDate this.createdAt}}
                        </span>
                      </td>

                      <!-- Thao tác -->
                      <td class="text-center">
                        <div class="btn-group" role="group">
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-orange"
                            onclick="previewDocument('{{this._id}}', '{{this.title}}')">
                            <i class="fas fa-eye"></i>
                          </button>

                          <a
                            href="/document/download/{{this._id}}"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="text-center py-4">
              <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
              <h6 class="text-muted mb-2">Chưa có tài liệu công khai nào</h6>
              <p class="text-muted small">
                Hãy quay lại sau hoặc tự chia sẻ tài liệu của bạn
              </p>
            </div>
          {{/if}}
        </div>
      </div>
    </div>

  </div>
</main>

<!-- Enhanced Modal for Document Preview -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-gradient-orange text-white">
        <h5 class="modal-title" id="previewModalLabel">
          Xem trước tài liệu
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="previewContent" class="text-center p-4">
          <div class="spinner-border text-orange" role="status">
            <span class="visually-hidden">Đang tải...</span>
          </div>
          <p class="mt-3 text-muted">Đang tải tài liệu...</p>
        </div>
      </div>
      {{!-- <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
        </button>
        <a href="/file/{{this.file}}" id="downloadLink" class="btn btn-orange">
          <i class="fas fa-download me-2"></i>
        </a>
      </div> --}}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // =========================
  // Upload tài liệu
  // =========================
  const fileUploadArea = document.getElementById('fileUploadArea');
  const fileInput = document.getElementById('file');
  const browseBtn = document.getElementById('browseBtn');
  const uploadPlaceholder = document.getElementById('uploadPlaceholder');
  const filePreview = document.getElementById('filePreview');

  if (fileUploadArea && fileInput) {
    ['dragover','drop'].forEach(evt =>
      window.addEventListener(evt, e => e.preventDefault())
    );

    ['dragenter','dragover'].forEach(evt =>
      fileUploadArea.addEventListener(evt, e => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
      })
    );

    ['dragleave','dragend'].forEach(evt =>
      fileUploadArea.addEventListener(evt, () =>
        fileUploadArea.classList.remove('dragover'))
    );

    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      const file = e.dataTransfer?.files?.[0];
      if (file) setFile(file);
    });

    browseBtn?.addEventListener('click', e => {
      e.preventDefault();
      fileInput.click();
    });

    fileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) setFile(this.files[0]);
    });

    function setFile(file) {
      const allowed = ['pdf','doc','docx','txt','ppt','pptx','xls','xlsx'];
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      const maxSize = 10 * 1024 * 1024;

      if (!allowed.includes(ext)) {
        alert('Loại file không hỗ trợ.');
        return reset();
      }
      if (file.size > maxSize) {
        alert('File quá lớn! Tối đa 10MB.');
        return reset();
      }

      uploadPlaceholder.classList.add('d-none');
      filePreview.classList.remove('d-none');
      filePreview.innerHTML = `
        <div class="file-name fw-bold">${escapeHtml(file.name)}</div>
        <div class="file-size small text-muted">${formatFileSize(file.size)}</div>
        <div class="mt-2">
          <button type="button" class="btn btn-outline-orange btn-sm" id="changeFileBtn">
            <i class="fas fa-times me-2"></i>Chọn file khác
          </button>
        </div>
      `;
      document.getElementById('changeFileBtn').addEventListener('click', reset);
    }

    function reset() {
      fileInput.value = '';
      filePreview.innerHTML = '';
      filePreview.classList.add('d-none');
      uploadPlaceholder.classList.remove('d-none');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024, sizes = ['Bytes','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<"'>]/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])
      );
    }
  }

    // Preview tài liệu (theo docId)
    window.previewDocument = function(docId, title) {
      const modalEl = document.getElementById('previewModal');
      const previewContent = document.getElementById('previewContent');
      {{!-- const downloadLink = document.getElementById('downloadLink'); --}}
      const modalTitle = document.getElementById('previewModalLabel');

      modalTitle.innerHTML = `Xem trước: ${title || ''}`;
      {{!-- downloadLink.href = `/document/download/${docId}`; --}}

      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      // Gọi trực tiếp route preview
      previewContent.innerHTML = `
        <iframe src="/document/preview/${docId}" 
                width="100%" height="600px" style="border:0"></iframe>`;
    };

    // Reset khi đóng modal
    document.getElementById('previewModal')?.addEventListener('hidden.bs.modal', () => {
      const previewContent = document.getElementById('previewContent');
      if (previewContent) {
        previewContent.innerHTML = `
          <div class="spinner-border text-orange" role="status"></div>
          <p class="mt-3 text-muted">Đang tải tài liệu...</p>
        `;
      }
    });
});
</script>

